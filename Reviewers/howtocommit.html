
<!DOCTYPE html>


<html lang="en" data-content_root="../" data-theme="auto">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Merge, Test &amp; Commit &#8212; Simulation Systems  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "auto";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "auto";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=880b0107" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Reviewers/howtocommit';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Committing Linked Pull Requests" href="committinglinkedtickets.html" />
    <link rel="prev" title="Code Review" href="codereview.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="auto">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/MO_SQUARE_black_mono_for_light_backg_RBG.png" class="logo__image only-light" alt=""/>
    <img src="../_static/MO_SQUARE_for_dark_backg_RBG.png" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">Simulation Systems</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../WorkingPractices/working_practices.html">
    Working Practices
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../Development/developing_change.html">
    Developing Your Change
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Guides for Reviewers
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../FurtherDetails/index.html">
    Further Details
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/MetOffice/simulation-systems/discussions" title="GitHub Discussions" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="far fa-comments fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub Discussions</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/MetOffice/simulation-systems" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../WorkingPractices/working_practices.html">
    Working Practices
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../Development/developing_change.html">
    Developing Your Change
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Guides for Reviewers
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../FurtherDetails/index.html">
    Further Details
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/MetOffice/simulation-systems/discussions" title="GitHub Discussions" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="far fa-comments fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub Discussions</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/MetOffice/simulation-systems" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Guides for Reviewers</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="scitechreview.html">Science and Technical Review</a></li>
<li class="toctree-l1"><a class="reference internal" href="codereview.html">Code Review</a></li>
<li class="toctree-l1 current active has-children"><a class="current reference internal" href="#">Merge, Test &amp; Commit</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="committinglinkedtickets.html">Committing Linked Pull Requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="nightlytesting.html">Nightly Testing</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="curaterelease.html">Curating a Release</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="releases/um_test_release.html">UM Test Release</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases/partner_testing.html">Partner Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases/software_stack.html">Scientific Software Stack Update</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases/jules_release.html">Jules Release</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases/shumlib_release.html">Shumlib Release</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases/mule_release.html">Mule Release</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases/um_main_release.html">UM Main Release</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases/lfric_apps_release.html">LFRic Apps Release</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases/release_notes.html">Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases/standard_suites.html">Standard Suites</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases/stash_browser.html">Stash Browser</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases/umdp_release.html">UMDP Release</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases/wiki_pages.html">Standard Jobs and Wiki Pages</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases/shared_accounts.html">Repo and Shared Accounts Permissions</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases/updating_prebuilds.html">Mid-Release Prebuilds</a></li>
</ul>
</details></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Guides for Reviewers</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Merge, Test &amp; Commit</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="merge-test-commit">
<span id="howtocommit"></span><h1>Merge, Test &amp; Commit<a class="headerlink" href="#merge-test-commit" title="Link to this heading">#</a></h1>
<p>The process for committing a PR follows this sequence with details for each
of these steps outlined below.</p>
<img alt="../_images/commit_process.png" class="dark-light" src="../_images/commit_process.png" />
<div class="admonition important">
<p class="admonition-title">Important</p>
<dl class="simple">
<dt>Before You Start:</dt><dd><ul class="simple">
<li><p>Is anyone else committing?</p>
<ul>
<li><dl class="simple">
<dt><a class="reference external" href="https://code.metoffice.gov.uk/trac/lfric_apps/wiki/TrunkStatus">Main Status</a> is used to coordinate <code class="docutils literal notranslate"><span class="pre">main</span></code> commits for all</dt><dd><p>projects.</p>
</dd>
</dl>
</li>
<li><p>Simple, not conflicting commits can be done in parallel if
reviewers all agree.</p></li>
<li><p>Changes with KGO or Macros usually require sole access to <code class="docutils literal notranslate"><span class="pre">main</span></code>.</p></li>
</ul>
</li>
<li><p>Check how many commits have happened today. Suggested limit per day,
per repository is 4.</p>
<ul>
<li><p>More than 4 can be committed if <code class="docutils literal notranslate"><span class="pre">all</span></code> groups have been run by a
team member.</p></li>
</ul>
</li>
</ul>
</dd>
</dl>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><strong>Linked PRs?</strong></p>
<p>If this is a set of linked PRs then the commit process will need to be
followed for each repository in parallel.
See <a class="reference internal" href="committinglinkedtickets.html#committinglinkedtickets"><span class="std std-ref">Committing Linked Pull Requests</span></a> for more details of how this works.</p>
<div class="toctree-wrapper compound">
</div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>All changes made by the reviewer (e.g. for upgrade macros, KGOs or linked
PRs) will be committed to the developers branch in their fork. All
testing should be run on this branch too. Once this is all complete then
GitHub can complete the merge of this branch to <code class="docutils literal notranslate"><span class="pre">main</span></code>.</p>
</div>
<section id="clone-branch">
<h2>1. Clone Branch<a class="headerlink" href="#clone-branch" title="Link to this heading">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If this is a linked PR, then do these steps for all pull requests</p>
</div>
<p>Ensure that the source branch is <a class="reference internal" href="../WorkingPractices/maintaining_forks.html#updating-branch"><span class="std std-ref">up to date with main</span></a>.
Only resolve conflicts that appear simple and you are comfortable with. If
there are more complicated conflicts ask the developer to solve them
themselves. If there are conflicts in versions.py then see the details in the
macro section below.</p>
<p>Then switch to the up to date branch, e.g.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>gh<span class="w"> </span>repo<span class="w"> </span>clone<span class="w"> </span>&lt;developer&gt;/&lt;fork_name&gt;<span class="w"> </span>&lt;clone_name&gt;<span class="w"> </span>--<span class="w"> </span>-b<span class="w"> </span>&lt;branch_name&gt;
</pre></div>
</div>
</section>
<section id="macros-if-required">
<h2>2. Macros (if required)<a class="headerlink" href="#macros-if-required" title="Link to this heading">#</a></h2>
<p><strong>If</strong> the PR includes metadata changes, upgrade macro changes or a new
rose-stem app then you will need to upgrade the test-suite.</p>
<section id="update-the-versions-py-file">
<h3>Update the versions.py file<a class="headerlink" href="#update-the-versions-py-file" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">versions.py</span></code> contains a sequence of upgrade macros. Each macro contains a
<code class="docutils literal notranslate"><span class="pre">BEFORE_TAG</span></code> and an <code class="docutils literal notranslate"><span class="pre">AFTER_TAG</span></code> which should create a single chain, starting
at the last release and finishing with the PR you are committing. The tags
have the format version_ticket, i.e. <code class="docutils literal notranslate"><span class="pre">vnXX.Y_tZZZZ</span></code>. The ticket value can be
either the Issue number of the PR number.</p>
<p>When resolving conflicts in this file make sure that the new macro being added
by your PR is added to the end of the file. Modify the <code class="docutils literal notranslate"><span class="pre">BEFORE_TAG</span></code> to
match the <code class="docutils literal notranslate"><span class="pre">AFTER_TAG</span></code> of the previous macro in the chain.</p>
<p>If this is the first macro since the release then the <code class="docutils literal notranslate"><span class="pre">BEFORE_TAG</span></code> will be the
version number with no added ticket number.</p>
<p>Remove the template macro if it is still present.</p>
</section>
<section id="apply-the-upgrade-macros">
<h3>Apply the upgrade macros<a class="headerlink" href="#apply-the-upgrade-macros" title="Link to this heading">#</a></h3>
<p>To update the test suite for an upgrade macro, please run:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-0">
UM</label><div class="sd-tab-content docutils">
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>./admin/rose-stem/update_all.py<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--path<span class="o">=</span>/path/to/um/clone<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--um<span class="o">=</span>vnXX.Y_tZZZZ<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="o">[</span>--jules-path<span class="o">=</span>/path/to/jules/clone<span class="o">]</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">--um=vnXX.Y_tZZZZ</span></code> is the <code class="docutils literal notranslate"><span class="pre">AFTER_TAG</span></code> of the latest
upgrade macro.</p>
<p>If there is a macro for fcm_make or createbc then check that the
makes <code class="docutils literal notranslate"><span class="pre">version*_*.py</span></code> has the correct BEFORE and AFTER tags and
append <code class="docutils literal notranslate"><span class="pre">--makeum=vnXX.Y_tZZZZ</span></code> and/or
<code class="docutils literal notranslate"><span class="pre">--createbc=vnXX.Y_tZZZZ</span></code> to the above command.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">--jules-path</span></code> option is only required if there are
linked changes to the <code class="docutils literal notranslate"><span class="pre">rose-meta/jules-shared</span></code> directory in the
Jules repository.</p>
</div>
</div>
<input id="sd-tab-item-1" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-1">
JULES</label><div class="sd-tab-content docutils">
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>./bin/upgrade_jules_test_apps<span class="w"> </span>vnX.Y_tZZZZ
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">vnX.Y_tZZZZ</span></code> is the <code class="docutils literal notranslate"><span class="pre">AFTER_TAG</span></code> of the latest upgrade
macro. The upgrade is expected to fail for the <code class="docutils literal notranslate"><span class="pre">fab_jules</span></code>,
<code class="docutils literal notranslate"><span class="pre">metadata_checker</span></code> and <code class="docutils literal notranslate"><span class="pre">umdp3_checker</span></code> apps.</p>
</div>
<input id="sd-tab-item-2" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-2">
LFRic Apps + Core</label><div class="sd-tab-content docutils">
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>apply_macros.py<span class="w"> </span>vnX.Y_tZZZZ<span class="w"> </span><span class="o">[</span>--apps<span class="o">=</span>/path/to/apps<span class="o">]</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="o">[</span>--core<span class="o">=</span>/path/to/core<span class="o">]</span><span class="w"> </span><span class="o">[</span>--jules<span class="o">=</span>/path/to/jules<span class="o">]</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">vnX.Y_tZZZZ</span></code> is the <code class="docutils literal notranslate"><span class="pre">AFTER_TAG</span></code> of the latest upgrade
macro and the others are paths to the relevant sources. Apps
defaults to the current location. Core and Jules default to
reading the <code class="docutils literal notranslate"><span class="pre">dependencies.yaml</span></code> file in the Apps source. A copy of
<code class="docutils literal notranslate"><span class="pre">apply_macros.py</span></code> is available at
<code class="docutils literal notranslate"><span class="pre">$UMDIR/SimSys_Scripts/lfric_macros</span></code>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">load</span> <span class="pre">scitools</span></code> will give all required dependencies
for Met Office users.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All LFRic Core PRs with macros are expected to be linked with an
LFRic Apps change.</p>
</div>
</div>
</div>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">New rose-stem app?</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">If the PR introduces a new rose-stem app, but doesn’t otherwise have a
macro then that app will need to be updated to match the metadata at the
head of <code class="docutils literal notranslate"><span class="pre">main</span></code>.</p>
<ol class="arabic">
<li><p class="sd-card-text">In the new app directory get a list of all available upgrade points by
running</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>rose<span class="w"> </span>app-upgrade<span class="w"> </span>-a<span class="w"> </span>-y<span class="w"> </span>-M<span class="w"> </span>path/to/working_copy/rose-meta
</pre></div>
</div>
</li>
<li><p class="sd-card-text">Select the latest upgrade point from the list provided and then run the
command again, adding this to the end</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>rose<span class="w"> </span>app-upgrade<span class="w"> </span>-a<span class="w"> </span>-y<span class="w"> </span>-M<span class="w"> </span>path/to/working_copy/rose-meta<span class="w"> </span>vnX.Y_tZZZZ
</pre></div>
</div>
</li>
</ol>
<p class="sd-card-text">The app should now be updated to the same metadata version as the rest of
the apps on the <code class="docutils literal notranslate"><span class="pre">main</span></code>. This can be checked with:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>rose<span class="w"> </span>macro<span class="w"> </span>--validate<span class="w"> </span>-M<span class="w"> </span>path/to/working_copy/rose-meta
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p class="sd-card-text">LFRic Apps PRs will require an LFRic Core source to use. You can do
this by checking out an appropriate clone, and exporting the
environment variable <code class="docutils literal notranslate"><span class="pre">ROSE_META_PATH=/path/to/core</span></code>.</p>
<p class="sd-card-text">For UM PRs, if there are linked changes to the
<code class="docutils literal notranslate"><span class="pre">rose-meta/jules-shared</span></code> directory in the Jules repository, then a
suitable Jules source will need to be included in the <cite>ROSE_META_PATH</cite>
as described above.</p>
</div>
</div>
</details><details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">Temporary Logical?</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">If a new temporary logical has been added, or an old one retired, then
update the <a class="reference external" href="https://code.metoffice.gov.uk/trac/um/wiki/TempUMlogicals">table that lists them</a>.</p>
</div>
</details><div class="admonition important">
<p class="admonition-title">Important</p>
<p>Now commit the changes made by the macros script back to the developers
branch.</p>
<p>Do not push the changes at this stage.</p>
</div>
</section>
</section>
<section id="test-if-no-kgo">
<h2>3. Test (if no KGO)<a class="headerlink" href="#test-if-no-kgo" title="Link to this heading">#</a></h2>
<p>The amount of testing to be done at this stage depends on the complexity of the
PR, and what has already been done. A minimum level is required for even
trivial PRs to check that the merge has not caused issues, or that there
are no clashes with what else has gone onto <code class="docutils literal notranslate"><span class="pre">main</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Linked PRs will need to be tested together as discussed on
the <a class="reference internal" href="committinglinkedtickets.html#testinglinked"><span class="std std-ref">Committing Linked PRs page</span></a>.</p>
</div>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-3" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-3">
UM</label><div class="sd-tab-content docutils">
<p>Run any necessary testing; at the very least run a compile group,
generally run developer, and more complex PRs warrant running
everything:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Update the group as appropriate, eg. developer or all</span>
cylc<span class="w"> </span>vip<span class="w"> </span>-z<span class="w"> </span><span class="nv">group</span><span class="o">=</span>debug_compile<span class="w"> </span>-n<span class="w"> </span>&lt;name/of/suite&gt;<span class="w"> </span>./rose-stem
</pre></div>
</div>
<p>If there is a change to the build configs then you may need to turn off
prebuilds. To do so update <code class="docutils literal notranslate"><span class="pre">rose-stem/site/meto/variables.cylc</span></code> such
that</p>
<div class="highlight-jinja notranslate"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">do</span> <span class="nv">SITE_VARS.update</span><span class="o">({</span><span class="s2">&quot;PREBUILDS&quot;</span> <span class="o">:</span> <span class="kp">false</span><span class="o">})</span> <span class="cp">%}</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-4" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-4">
JULES</label><div class="sd-tab-content docutils">
<p>The JULES test suite is quick to run, so it’s usual to test <code class="docutils literal notranslate"><span class="pre">all</span></code> for
any PR. If you have the appropriate environment setup then include
the <code class="docutils literal notranslate"><span class="pre">fab</span></code> group too.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cylc<span class="w"> </span>vip<span class="w"> </span>-z<span class="w"> </span><span class="nv">group</span><span class="o">=</span>all<span class="w"> </span>-n<span class="w"> </span>&lt;name/of/suite&gt;<span class="w"> </span>./rose-stem
</pre></div>
</div>
</div>
<input id="sd-tab-item-5" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-5">
UKCA</label><div class="sd-tab-content docutils">
<p>The UKCA rose-stem contains minimal tests at the moment, but should be
run to confirm the style checker passes.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cylc<span class="w"> </span>vip<span class="w"> </span>-z<span class="w"> </span><span class="nv">group</span><span class="o">=</span>all<span class="w"> </span>-n<span class="w"> </span>&lt;name/of/suite&gt;<span class="w"> </span>./rose-stem
</pre></div>
</div>
<p>UKCA testing should also be carried out using the UM rose stem. See
<a class="reference internal" href="committinglinkedtickets.html#testinglinked"><span class="std std-ref">Linked PRs page</span></a> for advice on how to set this
up.</p>
</div>
<input id="sd-tab-item-6" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-6">
LFRic Apps</label><div class="sd-tab-content docutils">
<p>LFRic Apps rose-stem contains tests spanning all the applications
included in the repository. At the very least run the developer group
which gives a basic level of tests spanning everything. The full set
of tests may be warranted for any application that has had more
complex changes.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Increase testing as appropriate, eg. lfric_atm or all</span>
cylc<span class="w"> </span>vip<span class="w"> </span>-z<span class="w"> </span><span class="nv">group</span><span class="o">=</span>developer<span class="w"> </span>-n<span class="w"> </span>&lt;name/of/suite&gt;<span class="w"> </span>./rose-stem
</pre></div>
</div>
</div>
<input id="sd-tab-item-7" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-7">
LFRic Core</label><div class="sd-tab-content docutils">
<p>Run the test suite command from the top level of the repository to run
a complete set of the rose-stem developer suites.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cylc<span class="w"> </span>vip<span class="w"> </span>-z<span class="w"> </span><span class="nv">group</span><span class="o">=</span>developer<span class="w"> </span>-n<span class="w"> </span>&lt;name/of/suite&gt;<span class="w"> </span>./rose-stem
</pre></div>
</div>
</div>
<input id="sd-tab-item-8" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-8">
UM docs</label><div class="sd-tab-content docutils">
<p>Check the documentation builds correctly:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>load<span class="w"> </span>latex
./build_umdoc.py<span class="w"> </span><span class="o">[</span>XXX<span class="w"> </span>YYY<span class="w"> </span>etc<span class="o">]</span>
</pre></div>
</div>
<p>where XXX YYY are the details of which docs require building.</p>
</div>
<input id="sd-tab-item-9" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-9">
JULES docs</label><div class="sd-tab-content docutils">
<p>JULES documentation is hosted within the <a class="reference external" href="https://github.com/jules-lsm/jules-lsm.github.io">JULES GitHub repository</a>. To review and
build the documentation branch locally, move to your local clone of
the JULES GitHub, then:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>pull
git<span class="w"> </span>switch<span class="w"> </span>&lt;branch<span class="w"> </span>name&gt;
<span class="nb">cd</span><span class="w"> </span>&lt;path_to&gt;/user_guide/doc
conda<span class="w"> </span>activate<span class="w"> </span>jules-user-guide
make<span class="w"> </span>html
firefox<span class="w"> </span>build/html/index.html
</pre></div>
</div>
<p>To build and check the LaTeX PDF:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>make<span class="w"> </span>latexpdf
evince<span class="w"> </span>build/latex/JULES_User_Guide.pdf
</pre></div>
</div>
</div>
</div>
</section>
<section id="kgo-supporting-data-if-required">
<h2>4. KGO &amp; Supporting Data (if required)<a class="headerlink" href="#kgo-supporting-data-if-required" title="Link to this heading">#</a></h2>
<p><strong>If</strong> your change is known to alter answers, you need to update rose-stem KGO
for all affected tests before you commit to the <code class="docutils literal notranslate"><span class="pre">main</span></code>.</p>
<p>Supporting data is stored in the filesystems of our machines and changes to use
will require the reviewer to update those files (BIG DATA).</p>
<p><em>NB: These instructions are Met Office specific, other sites may manage their
KGO differently</em></p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">Setup for first KGO install (UM + LFRic Inputs)</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">If doing a UM or LFRic Inputs KGO, before you start the process below there
is a one-time setup step required to allow you to generate KGO using the
update script.</p>
<p class="sd-card-text">Edit <code class="docutils literal notranslate"><span class="pre">~/.metomi/rose.conf</span></code> on <em>all platforms</em> - VDI, EXAB, EXCD, EXZ</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">rose</span><span class="o">-</span><span class="n">ana</span><span class="p">]</span>
<span class="n">kgo</span><span class="o">-</span><span class="n">database</span><span class="o">=.</span><span class="n">true</span><span class="o">.</span>
</pre></div>
</div>
</div>
</details><div class="sd-tab-set docutils" id="kgo-instructions">
<input checked="checked" id="sd-tab-item-10" name="sd-tab-set-2" type="radio">
<label class="sd-tab-label" for="sd-tab-item-10">
UM + LFRic Inputs</label><div class="sd-tab-content docutils">
<p>KGO files are stored in <code class="docutils literal notranslate"><span class="pre">$UMDIR/standard_jobs/kgo</span></code> or
<code class="docutils literal notranslate"><span class="pre">$UMDIR/standard_jobs/lfricinputs/kgo</span></code> and are installed there using
a script.</p>
<ol class="arabic simple">
<li><p>Run the rose stem tasks that require a KGO update, plus any other
testing required (see above) - if unsure run the <cite>all</cite> group.</p></li>
</ol>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cylc<span class="w"> </span>vip<span class="w"> </span>-z<span class="w"> </span><span class="nv">group</span><span class="o">=</span>all<span class="w"> </span>-n<span class="w"> </span>&lt;name/of/suite&gt;<span class="w"> </span>./rose-stem
</pre></div>
</div>
<ol class="arabic simple">
<li><p>You will need access to both a clone with the branch active, and
up to date with <code class="docutils literal notranslate"><span class="pre">main</span></code>, and a clone of the <a class="reference external" href="https://github.com/MetOffice/SimSys_Scripts">SimSys_Scripts github
repo</a> (one is
available in $UMDIR). Run the script
<code class="docutils literal notranslate"><span class="pre">kgo_updates/meto_update_kgo.sh</span></code> which is located in
SimSys_Scripts.</p></li>
<li><dl class="simple">
<dt>The script will ask you to enter some details regarding the PR.</dt><dd><ul class="simple">
<li><p>Platforms: enter each platform which has a kgo change, lower case
and space seperated, e.g. <cite>azspice ex1a</cite></p></li>
<li><p>If running on the EX’s it will ask for the host you ran on - this
can be found from Cylc Review.</p></li>
<li><p>Path to your local clone - the script will check this exists and
will fail if it can’t be found.</p></li>
<li><p>KGO directory: this will default to vnXX.X_tYYYY where XX.X is
the version number and YYYY is the PR number.</p></li>
<li><p>There are further prompts to the user through the script - in
particular to check the shell script produced.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>If running on EX’s the script will ask whether to rsync UM files or
lfricinputs files to the other EX hosts. Select the appropriate
option.</p></li>
<li><p>Check that the new KGO has been installed correctly by restarting
your suite, retriggering the failed rose-ana tasks and checking
they now pass.</p></li>
<li><p>Once committed, update the <a class="reference external" href="https://code.metoffice.gov.uk/trac/um/wiki/LoseBitComparison">bit comparison table</a>.</p></li>
</ol>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">More details on KGO update script</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<ul class="simple">
<li><p class="sd-card-text">This script will login as the relevant admin user as needed</p></li>
<li><p class="sd-card-text">After running for a platform, the newly created variables.cylc and
shell script will be moved to Azspice
$UMDIR/kgo_update_files/&lt;new_kgo_directory&gt;.</p></li>
<li><p class="sd-card-text">Having run on each requested platform the new variables.cylc files
will be copied into your clone
rose-stem/site/meto/variables_&lt;PLATFORM&gt;.cylc.</p></li>
</ul>
</div>
</details><details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">Updating KGO manually (rarely needed!)</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<ul class="simple">
<li><p class="sd-card-text">Create a new directory for the new KGO. The naming convention is
vnXX.X_tNNNN, where NNNN is the PR number. The location of
the KGO for the nightly is $UMDIR/standard_jobs.</p></li>
<li><p class="sd-card-text">Copy the new KGO from your rose-stem run into the directory
vnXX.X_tNNNN created above. Note that you need to provide a
complete set of files, not just ones which have changed answers.
This includes the reconfiguration .astart file!</p></li>
<li><p class="sd-card-text">If a file hasn’t changed you can optionally symlink forwards from
the previous version (i.e. move the old file to the new KGO
directory and replace it with a sym-link to the updated version)
But do not do this if the old version was a major release (vnX.X),
this is to allow intermediate kgo installs to be deleted later.</p></li>
<li><p class="sd-card-text">Remember to RSync and update the bitcomparison table(see above).</p></li>
</ul>
</div>
</details></div>
<input id="sd-tab-item-11" name="sd-tab-set-2" type="radio">
<label class="sd-tab-label" for="sd-tab-item-11">
JULES</label><div class="sd-tab-content docutils">
<ol class="arabic simple">
<li><p>Run the standalone rose-stem with <strong>housekeeping switched off</strong> to
generate new KGO.</p></li>
</ol>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cylc<span class="w"> </span>vip<span class="w"> </span>-z<span class="w"> </span><span class="nv">group</span><span class="o">=</span>all<span class="w"> </span>-n<span class="w"> </span>&lt;name/of/suite&gt;<span class="w"> </span>./rose-stem
</pre></div>
</div>
<ol class="arabic">
<li><p>Update KGO_VERSION in <cite>rose-stem/include/variables.cylc</cite>.</p></li>
<li><p>Copy the new KGO to the correct locations:</p>
<p><a class="reference external" href="https://github.com/MetOffice/git_playground/wiki/Jules-KGO-Instructions">JULES KGO commands</a></p>
</li>
<li><p>Rerun the rose-stem tests to make sure nothing is broken.</p></li>
</ol>
</div>
<input id="sd-tab-item-12" name="sd-tab-set-2" type="radio">
<label class="sd-tab-label" for="sd-tab-item-12">
LFRic Apps + LFRic Core</label><div class="sd-tab-content docutils">
<p>KGO Checksums are stored in the repository alongside the code and can
be updated using a script. This can be done by either the Code
Reviewer or by the developer (before submitting their changes for
review). In the latter case, the update will need redoing by the
reviewer before commit if there are merge conflicts in the checksum
files.</p>
<ol class="arabic simple">
<li><p>Fix any merge conflicts in the checksums - it shouldn’t matter which
merge option is selected as you will be overwriting these checksum
files again in the following steps.</p></li>
<li><p>Run the rose stem tasks that require a KGO update, plus any other
testing required (see above) - if unsure run the <code class="docutils literal notranslate"><span class="pre">all</span></code> group.</p></li>
</ol>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cylc<span class="w"> </span>vip<span class="w"> </span>-z<span class="w"> </span><span class="nv">group</span><span class="o">=</span>all<span class="w"> </span>-n<span class="w"> </span>&lt;name/of/suite&gt;<span class="w"> </span>./rose-stem
</pre></div>
</div>
<ol class="arabic simple">
<li><p>Ensure the failing KGO’s match those on the branch.</p></li>
<li><p>Run the checksum update script stored in
<code class="docutils literal notranslate"><span class="pre">&lt;local_clone&gt;/rose-stem/bin</span></code>.</p></li>
</ol>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python3<span class="w"> </span>./rose-stem/bin/update_branch_kgos.py<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-s<span class="w"> </span>&lt;suite<span class="w"> </span>name/runX&gt;<span class="w"> </span>-w<span class="w"> </span>&lt;path<span class="w"> </span>to<span class="w"> </span>clone&gt;
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The numbered run directory must be included in the suite name, e.g.
<code class="docutils literal notranslate"><span class="pre">name-of-suite/run1</span></code>.</p>
</div>
<ol class="arabic simple">
<li><p>Verify the checksums updated properly by retriggering the failed
checksums. First retrigger <code class="docutils literal notranslate"><span class="pre">export-source</span></code>, and then when
complete <code class="docutils literal notranslate"><span class="pre">export-source_ex1a</span></code> if new checksums are present there
(there is no need to retigger azspice). You may need to change the
maximum window extent of the gui in order to see the succeeded
tasks. Now you can retrigger the failed checksums - these should
now pass if the kgo was updated in the clone correctly.</p></li>
</ol>
</div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Now commit the changes made by the KGO script back to the developers
branch.</p>
<p>Do not push the changes at this stage.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Between running any required testing and installing the KGO check that the
failing rose-ana tasks match those in the developers trac.log. If any have
failed for other reasons (e.g. timeout) then these should be re-triggered
before attempting to install the KGO files.</p>
</div>
<section id="managing-big-data">
<h3>4.1 Managing BIG DATA<a class="headerlink" href="#managing-big-data" title="Link to this heading">#</a></h3>
<p>Static input data, such as initialisations and ancilliaries, are required by
many tests.</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-13" name="sd-tab-set-3" type="radio">
<label class="sd-tab-label" for="sd-tab-item-13">
LFRic apps</label><div class="sd-tab-content docutils">
<p>LFRic apps tests use a BIG_DATA_DIR environment variable to provide a
platform based path prefix to provide direct access to data required
for tests.</p>
<p>The master copy of this is held on Azure Spice at
<code class="docutils literal notranslate"><span class="pre">/data/users/lfricadmin/data/</span></code>.</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">cron sync</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">A <code class="docutils literal notranslate"><span class="pre">cron</span></code> job is run daily at 04:30 utc on Azure Spice as the
<code class="docutils literal notranslate"><span class="pre">lfricadmin</span></code> user, which runs the script:</p>
<p class="sd-card-text"><a class="github reference external" href="https://github.com/MetOffice/lfric_tools/tree/main/bigData/rsyncBigData.sh">MetOffice/lfric_tools</a></p>
<p class="sd-card-text">from</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>/home/users/lfricadmin/bigDataManagement/rsyncBigData.sh
</pre></div>
</div>
<p class="sd-card-text">This script synchronises the content of
<code class="docutils literal notranslate"><span class="pre">/data/users/lfricadmin/data/</span></code> from Azure Spice to <cite>EXAB</cite> and
<code class="docutils literal notranslate"><span class="pre">EXCD</span></code>, deleting all content not in Azure Spice BIG_DATA from
the remote locations and updating any changed content.</p>
</div>
</details><p>This BIG_DATA_DIR is not versioned nor source controlled on any
platform. Care is required. The ability to log in as the <cite>lfricadmin</cite>
user is required, e.g. via</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>-u<span class="w"> </span>lfricadmin<span class="w"> </span>-i
</pre></div>
</div>
</div>
</div>
<p>As reviewer, you should work with the developer, prior to moving to the commit
stage, to:</p>
<ol class="arabic simple">
<li><p>Place new files in the appropriate location on Azure Spice under
<code class="docutils literal notranslate"><span class="pre">/data/users/lfricadmin/data/</span></code></p></li>
<li><p>Run relevant tests on Azure Spice.</p></li>
<li><p>Wait for the daily <code class="docutils literal notranslate"><span class="pre">cron</span></code> job to run to synchronise data between Azure
Spice and <code class="docutils literal notranslate"><span class="pre">EXAB</span></code> + <code class="docutils literal notranslate"><span class="pre">EXCD</span></code>.</p></li>
<li><p>Ensure that you are in charge of <code class="docutils literal notranslate"><span class="pre">main</span></code> for the repositories involved.</p></li>
<li><p>Update your clone if other commits have happened.</p></li>
<li><p>Rerun relevant tests</p></li>
</ol>
<p>If the requirement is to update existing files, then further care is required.</p>
<ol class="arabic simple">
<li><p>Ensure that you are in charge of the in charge of <code class="docutils literal notranslate"><span class="pre">main</span></code> for the
repositories involved.</p></li>
<li><p>Retain a temporary copy of the existing files, using a <cite>.old</cite> suffix.</p></li>
<li><p>Place updated files in the appropriate location on Azure Spice under
<code class="docutils literal notranslate"><span class="pre">/data/users/lfricadmin/data/</span></code></p></li>
<li><p>Run all tests on Azure Spice only</p>
<ul class="simple">
<li><p>revert changes immediately if there are any issues, and consult with the
developer.</p></li>
</ul>
</li>
<li><p>Manually trigger the synchronisation script to synchronise data between
platforms</p>
<ul class="simple">
<li><p>Waiting for the daily <code class="docutils literal notranslate"><span class="pre">cron</span></code> job to run can introduce a misalignment or
race condition for scheduled testing.</p></li>
</ul>
</li>
<li><p>Rerun relevant tests on EX machines</p>
<ul class="simple">
<li><p>revert changes immediately if there are any issues, and consult with the
developer.</p></li>
</ul>
</li>
<li><p>Remove any <code class="docutils literal notranslate"><span class="pre">.old</span></code> files that you created on Azure Spice.</p></li>
</ol>
</section>
</section>
<section id="commit">
<span id="id1"></span><h2>5. Commit<a class="headerlink" href="#commit" title="Link to this heading">#</a></h2>
<p>Once testing has passed on the local Met Office machines then ensure all
changes for macros and kgos have been committed to the local copy of the
branch and then push the changes back to the remote branch.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you get a permission denied error when trying to push, ensure the pull
request allows edits by maintainers, and ask the developer to change it if
not.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Linked PRs will also need to update the relevant hashes for sub-repos
before pushing back to the fork. See <a class="reference internal" href="committinglinkedtickets.html#committinglinked"><span class="std std-ref">Committing Linked PRs</span></a> for details.</p>
</div>
<p>Once the remote branch has been updated, the pull request continuous
integration will relaunch. Make sure this all passes and then you can commit
the PR via the GitHub interface,</p>
<img alt="../_images/merge_light.png" class="only-light border" src="../_images/merge_light.png" />
<img alt="../_images/merge_dark.png" class="only-dark border" src="../_images/merge_dark.png" />
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Don’t forget to let the team know you’ve finished with main.</p>
</div>
</section>
<section id="close">
<h2>6. Close<a class="headerlink" href="#close" title="Link to this heading">#</a></h2>
<p>Nightly testing results are usually checked with a status posted on <a class="reference external" href="https://code.metoffice.gov.uk/trac/lfric_apps/wiki/TrunkStatus">Main
Status</a>. If this hasn’t been done then <a class="reference internal" href="nightlytesting.html#nightlytesting"><span class="std std-ref">check the nightly results</span></a>.</p>
<p>If something is broken:</p>
<ul class="simple">
<li><p>Announce to the team and on <a class="reference external" href="https://code.metoffice.gov.uk/trac/lfric_apps/wiki/TrunkStatus">Main Status</a>.</p></li>
<li><p>There are a few possibilities for how to proceed,</p>
<ul>
<li><p>If the fix is obvious and trivial then create a quick PR on a branch from
<code class="docutils literal notranslate"><span class="pre">main</span></code> and find someone to review it. If the developer is available
and able to fix it then they can make the pr and you can review.</p></li>
<li><p>If there isn’t an easy fix then reverse the change to allow time for
investigation.</p></li>
</ul>
</li>
</ul>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">Reversing Commits to Main</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p class="sd-card-text">Reverting a commit from main will require the help of a friendly
repository admin.</p>
</div>
<p class="sd-card-text"><strong>The Admin:</strong></p>
<p class="sd-card-text">Navigate to the repository rulesets under settings,</p>
<img alt="../_images/rulesets_light.png" class="only-light border" src="../_images/rulesets_light.png" />
<img alt="../_images/rulesets_dark.png" class="only-dark border" src="../_images/rulesets_dark.png" />
<p class="sd-card-text">and then temporarily disable the <code class="docutils literal notranslate"><span class="pre">prevent_updates</span></code> ruleset. This will
allow a branch to be created in the repository to revert the change.</p>
<img alt="../_images/prevent_updates_disabled_light.png" class="only-light border" src="../_images/prevent_updates_disabled_light.png" />
<img alt="../_images/prevent_updates_disabled_dark.png" class="only-dark border" src="../_images/prevent_updates_disabled_dark.png" />
<p class="sd-card-text"><strong>The Original Reviewer:</strong></p>
<p class="sd-card-text">From the closed pull request, select the option to revert the merge,</p>
<img alt="../_images/revert_light.png" class="only-light border" src="../_images/revert_light.png" />
<img alt="../_images/revert_dark.png" class="only-dark border" src="../_images/revert_dark.png" />
<p class="sd-card-text">If there are any conflicts with later commits then fix these. A new branch
with the revert will be created and a pull request will be opened.
Checkout this branch and run local testing. Then request a review from the
admin.</p>
<p class="sd-card-text"><strong>The Admin:</strong></p>
<p class="sd-card-text">Review the change and ensure testing has been completed, then commit the
pull request.</p>
<p class="sd-card-text">Finally, reenable the branch protection rule you disabled earlier.</p>
</div>
</details><div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><strong>Logging in as an admin user</strong></p>
<ul class="simple">
<li><p>To access the admin account you’ll need to be added to the admin-access
list by an admin-owner. This is managed through Active Directory</p></li>
<li><p>When logged in to your linux desktop run <code class="docutils literal notranslate"><span class="pre">xsudo</span> <span class="pre">-iu</span> <span class="pre">&lt;ADMIN-USERNAME&gt;</span></code>.</p></li>
<li><p>You can then access other machines as the admin user via <code class="docutils literal notranslate"><span class="pre">ssh</span> <span class="pre">-Y</span>
<span class="pre">&lt;HOSTNAME&gt;</span></code>.</p></li>
</ul>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="codereview.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Code Review</p>
      </div>
    </a>
    <a class="right-next"
       href="committinglinkedtickets.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Committing Linked Pull Requests</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clone-branch">1. Clone Branch</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#macros-if-required">2. Macros (if required)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#update-the-versions-py-file">Update the versions.py file</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-the-upgrade-macros">Apply the upgrade macros</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-if-no-kgo">3. Test (if no KGO)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kgo-supporting-data-if-required">4. KGO &amp; Supporting Data (if required)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#managing-big-data">4.1 Managing BIG DATA</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#commit">5. Commit</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#close">6. Close</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

<p class="copyright">
    
    © Crown Copyright, Met Office
    <br/>
    
</p>
</div>
      
    </div>
  
  
    <div class="footer-items__center">
      
        <div class="footer-item">
<div class="tocsection accessibilitylink">
        <a href="../accessibility.html">Accessibility</a>
</div></div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>