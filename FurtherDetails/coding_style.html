
<!DOCTYPE html>


<html lang="en" data-content_root="../" data-theme="auto">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Software standards &#8212; Simulation Systems  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "auto";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "auto";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=880b0107" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'FurtherDetails/coding_style';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Recent Changes" href="change_notes.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="auto">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/MO_SQUARE_black_mono_for_light_backg_RBG.png" class="logo__image only-light" alt=""/>
    <img src="../_static/MO_SQUARE_for_dark_backg_RBG.png" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">Simulation Systems</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../WorkingPractices/working_practices.html">
    Working Practices
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../Development/developing_change.html">
    Developing Your Change
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../Reviewers/index.html">
    Guides for Reviewers
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Further Details
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/MetOffice/simulation-systems/discussions" title="GitHub Discussions" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="far fa-comments fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub Discussions</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/MetOffice/simulation-systems" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../WorkingPractices/working_practices.html">
    Working Practices
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../Development/developing_change.html">
    Developing Your Change
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../Reviewers/index.html">
    Guides for Reviewers
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Further Details
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/MetOffice/simulation-systems/discussions" title="GitHub Discussions" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="far fa-comments fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub Discussions</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/MetOffice/simulation-systems" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Further Details</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="who.html">Who’s Who</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Simulation Systems Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributor Licence Agreement and Certificate of Origin</a></li>
<li class="toctree-l1"><a class="reference internal" href="ai.html">AI Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="dos_donts.html">Do’s and Don’ts</a></li>
<li class="toctree-l1"><a class="reference internal" href="change_notes.html">Recent Changes</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Software standards</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Further Details</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Software standards</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="software-standards">
<span id="standards"></span><h1>Software standards<a class="headerlink" href="#software-standards" title="Link to this heading">#</a></h1>
<section id="introduction">
<span id="sec-intro"></span><h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>This document specifies the software standards and coding styles to be used
when writing new code files for the Met Office Unified Model. When
making <strong>extensive</strong> changes to an existing file a <strong>rewrite</strong> of the whole
file should be done to ensure that the file meets the UM coding standard and
style. <strong>All code modifications within an existing file should follow these
standards</strong>.</p>
<p>The only exception to following these coding standards is that there is no
requirement to rewrite ‘imported code’ to these standards before it is
included within the UM. All new code developed within the Met Office should
follow these standards.</p>
<p>Imported code; is developed as part of a collaboration project and then
proposed to be suitable for use within the UM; for example the original UKCA
code developed in academia. Collaborative developed code specifically for the
UM should meet these standards.</p>
<section id="why-have-standards">
<h3>Why have standards?<a class="headerlink" href="#why-have-standards" title="Link to this heading">#</a></h3>
<p>This document is intended for new as well as experienced programmers, so a few
words about why there is a need for software standards and styles may be in
order.</p>
<p>Coding standards specify a standard working practice for a project with the aim
of improving portability, maintainability and the readability of code. This
process makes code development and reviewing easier for all developers
involved in the project. Remember that software should be written for people
and not just for computers! As long as the syntax rules of the programming
language (e.g. Fortran IV - 2003) are followed, the computer does not care how
the code is written. You could use archaic language structures, add no
comments, leave no spaces etc. However, another programmer trying to use,
maintain or alter the code will have trouble working out what the code does
and how it does it. A little extra effort whilst writing the code can greatly
simplify the task of this other programmer (which might be the original author
a year or so after writing the code, when details of it are bound to have been
forgotten). In addition, following these standards may well help you to write
better, more efficient, programs containing fewer bugs.</p>
<p>While code style is very subjective, by standardising the style, UM routine
layout will become familiar to all code developers/reviewers even when they
are not familiar with the underlying science.</p>
</section>
<section id="units">
<h3>Units<a class="headerlink" href="#units" title="Link to this heading">#</a></h3>
<p>All routines and documentation must be written using SI units. Standard SI
prefixes may be used. Where relevant, the units used must be clearly stated in
both the code and the supporting UM documentation.</p>
</section>
<section id="working-practices">
<h3>Working practices<a class="headerlink" href="#working-practices" title="Link to this heading">#</a></h3>
<p>The preparation of new files and of changes to existing files should, meet this
UM standard documentation and must be developed following the stages outlined
in <a class="reference external" href="https://metoffice.github.io/simulation-systems">Working Practices for UM Development</a>.</p>
</section>
<section id="examples">
<h3>Examples<a class="headerlink" href="#examples" title="Link to this heading">#</a></h3>
<p>This document provides an example programming unit to aid the code developer.
This example meets the standards detailed within this paper, with references
to the relevant sections.</p>
</section>
<section id="technical-standards">
<h3>Technical standards<a class="headerlink" href="#technical-standards" title="Link to this heading">#</a></h3>
<p>UM code should be written in and conform to the Fortran 2003 standard; this is
supported by most <a class="reference external" href="http://fortranwiki.org/fortran/show/Fortran+2003+status">major Fortran compilers</a>. Obsolescent
language features are not permitted. The UM also requires compiler support for
Technical Specification 29113 on the Further Interoperability of Fortran with
C. This is a new feature for Fortran 2018, but is a <a class="reference external" href="http://fortranwiki.org/fortran/show/Compiler+Support+for+Modern+Fortran">common extension in most
compilers</a>
and has widespread support.</p>
<p>Please note that in order to maximise portability and to avoid the use of
radically different design structures within single areas of code, some
Fortran 2003 features are excluded from use within the UM. For further details
please see <a class="reference internal" href="#appendix-b">Appendix B</a>.</p>
</section>
<section id="pre-processor">
<h3>Pre-processor<a class="headerlink" href="#pre-processor" title="Link to this heading">#</a></h3>
<p>In the past include files and C pre-processor were used for scientific code
section choices and passing a large list of arrays. This use has been phased
out and highly discouraged. The C pre-processor is still used to make machine
specific choices and, together with included files, to reduced code
duplication. These are all covered by this standards and style document.</p>
</section>
</section>
<section id="how-to-meet-the-coding-standards">
<span id="example"></span><h2>How to meet the coding standards<a class="headerlink" href="#how-to-meet-the-coding-standards" title="Link to this heading">#</a></h2>
<p>The following code example exhibits all that is defined as a good coding
standard and how code should be written for inclusion within the UM.</p>
<p>The example is highlighted with references (section links) to the remainder of
this document which provide further details on the standard and style used.</p>
<pre class="literal-block">example_mod.F90                                                                     <a class="reference internal" href="#s1">S1</a>


! <strong>***************************COPYRIGHT*****************************</strong>             <a class="reference internal" href="#s2">S2</a>
! (C) Crown copyright Met Office. All rights reserved.
! For further details please refer to the file COPYRIGHT.txt
! which you should have received as part of this distribution.
! <strong>***************************COPYRIGHT*****************************</strong>             <a class="reference internal" href="#s2">S2</a>
!
! An example routine depicting how one should construct
! new code to meet the UMDP3 coding standards.                                      <a class="reference internal" href="#s2">S2</a>
!
MODULE example_mod                                                      <a class="reference internal" href="#s3">S3</a> <a class="reference internal" href="#s4">S4</a> <a class="reference internal" href="#s6">S6</a>

IMPLICIT NONE                                                                       <a class="reference internal" href="#s7">S7</a>

! Description:                                                                      <a class="reference internal" href="#s2">S2</a>
!   A noddy routine that illustrates the way to apply the UMDP3
!   coding standards to help code developers
!   pass code reviews.
!
! Method:                                                                           <a class="reference internal" href="#s2">S2</a>
!   In this routine we apply many of the UMDP3 features
!   to construct a simple routine. The references on the RHS take the reader
!   to the appropriate section of the UMDP3 guide with further details.
!
! Code Owner: Please refer to the UM file CodeOwners.txt                            <a class="reference internal" href="#s2">S2</a>
! This file belongs in section: Control
!
! Code description:                                                                 <a class="reference internal" href="#s2">S2</a>
!  Language: Fortran 2003.
!  This code is written to UMDP3 standards.
!

CHARACTER(LEN=*), PARAMETER, PRIVATE :: ModuleName='EXAMPLE_MOD'                   <a class="reference internal" href="#s14">S14</a>

CONTAINS                                                                            <a class="reference internal" href="#s1">S1</a>

! Subroutine Interface:
SUBROUTINE example (xlen, ylen, l_unscale, input1, input2, &amp;                       <a class="reference internal" href="#s10">S10</a>
                  output, l_loud_opt)
! Description:
!   Nothing further to add to module description.                                   <a class="reference internal" href="#s2">S2</a>
USE atmos_constants_mod,    ONLY: r                                                 <a class="reference internal" href="#s6">S6</a>
USE ereport_mod,            ONLY: ereport
USE parkind1,               ONLY: jpim, jprb                                       <a class="reference internal" href="#s14">S14</a>
USE umprintMgr,             ONLY: umprint, ummessage, PrNorm                       <a class="reference internal" href="#s12">S12</a>
USE errormessagelength_mod, ONLY: errormessagelength
USE yomhook,                ONLY: lhook, dr_hook                                   <a class="reference internal" href="#s14">S14</a>

IMPLICIT NONE                                                                       <a class="reference internal" href="#s7">S7</a>

! Subroutine arguments
INTEGER, INTENT(IN)  :: xlen  ! Length of first dimension of the arrays.            <a class="reference internal" href="#s7">S7</a>
INTEGER, INTENT(IN)  :: ylen  ! Length of second dimension of the arrays.

LOGICAL, INTENT(IN)  :: l_unscale  ! switch scaling off.

REAL, INTENT(IN)     :: input1(xlen, ylen) ! First input array                      <a class="reference internal" href="#s7">S7</a>

REAL, INTENT(IN OUT) :: input2(xlen, ylen) ! Second input array                     <a class="reference internal" href="#s7">S7</a>
REAL, INTENT(OUT)    :: output(xlen, ylen) ! Contains the result                    <a class="reference internal" href="#s7">S7</a>

LOGICAL, INTENT(IN), OPTIONAL :: l_loud_opt ! optional debug flag                   <a class="reference internal" href="#s7">S7</a>

! Local variables
INTEGER(KIND=jpim), PARAMETER :: zhook_in  = 0  ! DrHook tracing entry       <a class="reference internal" href="#s7">S7</a> <a class="reference internal" href="#s14">S14</a>
INTEGER(KIND=jpim), PARAMETER :: zhook_out = 1  ! DrHook tracing exit              <a class="reference internal" href="#s14">S14</a>
INTEGER :: i          ! Loop counter
INTEGER :: j          ! Loop counter
INTEGER :: icode      ! error code for EReport
LOGICAL :: l_loud     ! debug flag (default false unless l_loud_opt is used)        <a class="reference internal" href="#s7">S7</a>

REAL, ALLOCATABLE :: field(:,:)     ! Scaling array to fill.                        <a class="reference internal" href="#s8">S8</a>
REAL(KIND=jprb)   :: zhook_handle   ! DrHook tracing                               <a class="reference internal" href="#s14">S14</a>
CHARACTER(LEN=*), PARAMETER :: RoutineName='EXAMPLE'                               <a class="reference internal" href="#s19">S19</a>
CHARACTER(LEN=errormessagelength) :: cmessage ! used for EReport
CHARACTER(LEN=256) :: my_char  ! string for output

! End of header
IF (lhook) CALL dr_hook(ModuleName//':'//RoutineName, zhook_in, zhook_handle)      <a class="reference internal" href="#s14">S14</a>

! Set debug flag if argument is present
l_loud = .FALSE.
IF (PRESENT(l_loud_opt)) THEN                                                       <a class="reference internal" href="#s7">S7</a>
  l_loud = l_loud_opt
END IF

my_char                                               &amp;                            <a class="reference internal" href="#s10">S10</a>
  =  'This is a very very very very very very very '  &amp;
  // 'loud character assignment'   ! A pointless long character example.
icode=0

! verbosity choice, output some numbers to aid with debugging                       <a class="reference internal" href="#s5">S5</a>
! protected by printstatus&gt;=PrNorm and pe=0
WRITE(ummessage,'(A,I0)') 'xlen=', xlen                                            <a class="reference internal" href="#s12">S12</a>
CALL umprint(ummessage, level=PrNorm, pe=0, src='example_mod')                     <a class="reference internal" href="#s13">S13</a>
WRITE(ummessage,'(A,I0)') 'ylen=', ylen
CALL umprint(ummessage, level=PrNorm, pe=0, src='example_mod')
IF (l_loud) CALL umprint(my_char, level=PrNorm, src='example_mod')

! Allocate and initialise scaling array                                             <a class="reference internal" href="#s5">S5</a>
! Noddy code warns user when scaling is not employed.
IF (l_unscale) THEN                                                                 <a class="reference internal" href="#s9">S9</a>
  icode = -100  ! set up WARNING message
  ALLOCATE(field(1,1))                                                              <a class="reference internal" href="#s8">S8</a>
  cmessage = 'Scaling is switched off in run!'
  CALL ereport(RoutineName, icode, cmessage)                                       <a class="reference internal" href="#s19">S19</a>
ELSE
  ALLOCATE(field(xlen, ylen))                                                       <a class="reference internal" href="#s8">S8</a>
  DO j = 1, ylen                                                                    <a class="reference internal" href="#s9">S9</a>
    DO i = 1, xlen                                                                  <a class="reference internal" href="#s9">S9</a>
      field(i, j)  = (1.0*i) + (2.0*j)                                              <a class="reference internal" href="#s4">S4</a>
      input2(i, j) = input2(i, j) * field(i, j)
    END DO
  END DO
END IF

! The main calculation of the routine, using OpenMP.                                <a class="reference internal" href="#s5">S5</a>
!$OMP PARALLEL DEFAULT(NONE) &amp;                                                     <a class="reference internal" href="#s15">S15</a>
!$OMP SHARED(xlen, ylen, input1, input2, field, output) &amp;
!$OMP PRIVATE(i, j)                                                                <a class="reference internal" href="#s15">S15</a>
!$OMP DO SCHEDULE(STATIC)
DO j = 1, ylen
  i_loop: DO i = 1, xlen                                                            <a class="reference internal" href="#s9">S9</a>
    ! Calculate the Output value:
    output(i, j) = (input1(i, j) * input2(i, j))
  END DO i_loop
END DO ! j loop
!$OMP END DO                                                                       <a class="reference internal" href="#s15">S15</a>
!$OMP END PARALLEL                                                                 <a class="reference internal" href="#s15">S15</a>

DEALLOCATE (field)                                                                  <a class="reference internal" href="#s8">S8</a>

IF (lhook) CALL dr_hook(ModuleName//':'//RoutineName, zhook_out, zhook_handle)     <a class="reference internal" href="#s14">S14</a>
RETURN
END SUBROUTINE example                                                              <a class="reference internal" href="#s4">S4</a>

END MODULE example_mod                                                              <a class="reference internal" href="#s4">S4</a></pre>
</section>
<section id="um-programming-standards-code-layout-formatting-style-and-fortran-features">
<span id="sec-general"></span><h2>UM programming standards; Code Layout, Formatting, Style and Fortran features<a class="headerlink" href="#um-programming-standards-code-layout-formatting-style-and-fortran-features" title="Link to this heading">#</a></h2>
<p>This section outlines the programming standards you should adhere to when
developing code for inclusion within the Unified Model. The rules set out in
this section aim to improve code readability and ensure that UM code is
compatible with the Fortran 2003 standard.</p>
<section id="s1-source-files-should-only-contain-a-single-program-unit">
<span id="s1"></span><h3>S1. Source files should only contain a single program unit<a class="headerlink" href="#s1-source-files-should-only-contain-a-single-program-unit" title="Link to this heading">#</a></h3>
<ul>
<li><p>Modules may be used to group related variables, subroutines and functions.
Each separate file within the source tree should be uniquely named.</p></li>
<li><p>The name of the file should reflect the name of the programming unit.
Multiple versions of the same file should be named <code class="docutils literal notranslate"><span class="pre">filename-#ver</span></code> where
<code class="docutils literal notranslate"><span class="pre">#ver</span></code> is the section/version number (e.g. 1a,2a,2b…). For example:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;filename-#ver&gt;.F90</span></code> when writing a <code class="docutils literal notranslate"><span class="pre">&lt;subroutine&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;filename_mod-#ver&gt;.F90</span></code> with writing a <code class="docutils literal notranslate"><span class="pre">&lt;module_mod&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;existing</span> <span class="pre">filename&gt;.F90</span></code> with <code class="docutils literal notranslate"><span class="pre">&lt;module_mod&gt;</span></code> only if upgrading
existing subroutine since Subversion does not handle renaming of files
very well and this allows history of the file to be easily retrieved.</p></li>
</ul>
<p>This makes it easier to navigate the UM code source tree for given routines.</p>
</li>
<li><p>You should avoid naming your <strong>program units</strong> and <strong>variables</strong> with names
that match an intrinsic <code class="docutils literal notranslate"><span class="pre">FUNCTION</span></code>, <code class="docutils literal notranslate"><span class="pre">SUBROUTINE</span></code> or <code class="docutils literal notranslate"><span class="pre">MODULE</span></code>. We
recommend the use of unique names within a program unit.</p></li>
<li><p>You should also avoid naming your program units and variables with names that
match a keyword in a Fortran statement.</p></li>
<li><p>Avoid giving program units names that are likely to be used as variable names
elsewhere in the code, e.g. <code class="docutils literal notranslate"><span class="pre">field</span></code> or <code class="docutils literal notranslate"><span class="pre">string</span></code>. This makes searching
the code difficult and can cause the code browser to make erroneous
connections between unrelated routines.</p></li>
<li><p>Subroutines should be kept reasonably short, where appropriate, say up to
about 100 lines of executable code, but don’t forget there are start up
overheads involved in calling an external subroutine so they should do a
reasonable amount of work.</p></li>
</ul>
</section>
<section id="s2-headers">
<span id="s2"></span><h3>S2. Headers<a class="headerlink" href="#s2-headers" title="Link to this heading">#</a></h3>
<ul>
<li><p>All programming units require a suitable copyright header. Met Office derived
code should use the standard UM copyright header as depicted in the good
example code. Collaborative UM developed code may require alternative
headers as agreed in the collaborative agreements. e.g. UKCA code. The IPR
(intellectual property rights) of UM code is important and needs to be
protected appropriately.</p></li>
<li><p>Headers are an immensely important part of any code as they document what it
does, and how it does it. You should write as much of the header as possible
BEFORE writing the code, as this will focus your mind on what you are doing
and how you intend to do it!</p></li>
<li><p>The description of the <code class="docutils literal notranslate"><span class="pre">MODULE</span></code> and its contained <code class="docutils literal notranslate"><span class="pre">SUBROUTINE</span></code> may be the
same and thus it need not be repeated in the latter. If a <code class="docutils literal notranslate"><span class="pre">MODULE</span></code>
contains more than one subroutine then further descriptions are required.</p></li>
<li><p>History comments should not be included in the header or routine code. Version
control provides the history of our codes.</p></li>
<li><p>Code author names should NOT be included explicitly within the code as they
quickly become out of date and are sometimes misleading. Instead we
reference a single maintainable text file which is included within the UM
code repository.</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">! Code Owner: Please refer to the UM file CodeOwners.txt</span>
<span class="c">! This file belongs in section: &lt;section_name_to_be_entered&gt;</span>
</pre></div>
</div>
</li>
<li><p>Example UM templates are provided with the source of this document;
subroutine, function and module templates.</p></li>
</ul>
</section>
<section id="s3-free-source-form">
<span id="s3"></span><h3>S3. Free source form<a class="headerlink" href="#s3-free-source-form" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>All code should be written using the free source form.</p></li>
<li><p>Please restrict code to 80 columns, so that your code can be easily viewed on
any editor and screen and can be printed easily on A4 paper.
<em>Note that CreateBC uses a limit of 100 columns, due to the nature of
the object-orientated code.</em></p></li>
<li><p>Never put more than one statement on a line.</p></li>
<li><p>Write your program in UK English, unless you have a very good reason for not
doing so. Write your comments in simple UK English and name your program
units and variables based on sensible UK English words. Always bear in mind
that your code may be read by people who are not proficient English
speakers.</p></li>
</ul>
</section>
<section id="s4-fortran-style">
<span id="s4"></span><h3>S4. Fortran style<a class="headerlink" href="#s4-fortran-style" title="Link to this heading">#</a></h3>
<ul>
<li><p>To improve readability, write your code using the ALL CAPS Fortran keywords
approach. The rest of the code may be written in either lower-case with
underscores or CamelCase. This approach has the advantage that Fortran
keywords stand out.</p></li>
<li><p>To improve readability, you should always use the optional space to separate
the Fortran keywords. The full list of Fortran keywords with an optional
spaces is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ELSE</span> <span class="n">IF</span>            <span class="n">END</span> <span class="n">DO</span>             <span class="n">END</span> <span class="n">FORALL</span>         <span class="n">END</span> <span class="n">FUNCTION</span>
<span class="n">END</span> <span class="n">IF</span>             <span class="n">END</span> <span class="n">INTERFACE</span>      <span class="n">END</span> <span class="n">MODULE</span>         <span class="n">END</span> <span class="n">PROGRAM</span>
<span class="n">END</span> <span class="n">SELECT</span>         <span class="n">END</span> <span class="n">SUBROUTINE</span>     <span class="n">END</span> <span class="n">TYPE</span>           <span class="n">END</span> <span class="n">WHERE</span>
<span class="n">SELECT</span> <span class="n">CASE</span>        <span class="n">ELSE</span> <span class="n">WHERE</span>         <span class="n">DOUBLE</span> <span class="n">PRECISION</span>   <span class="n">END</span> <span class="n">ASSOCIATE</span>
<span class="n">END</span> <span class="n">BLOCK</span>          <span class="n">END</span> <span class="n">BLOCK</span> <span class="n">DATA</span>     <span class="n">END</span> <span class="n">ENUM</span>           <span class="n">END</span> <span class="n">FILE</span>
<span class="n">END</span> <span class="n">PROCEDURE</span>      <span class="n">GO</span> <span class="n">TO</span>              <span class="n">IN</span> <span class="n">OUT</span>             <span class="n">SELECT</span> <span class="n">TYPE</span>
</pre></div>
</div>
<p>Note that not all of these are approved or appropriate for use in UM code.
This rule also applies to OpenMP keywords. (See: <a class="reference internal" href="#s15">S15</a>)</p>
</li>
<li><p>The full version of <code class="docutils literal notranslate"><span class="pre">END</span></code> should be used at all times, eg <code class="docutils literal notranslate"><span class="pre">END</span> <span class="pre">SUBROUTINE</span>
<span class="pre">&lt;name&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">END</span> <span class="pre">FUNCTION</span> <span class="pre">&lt;name&gt;</span></code></p></li>
<li><p>New code should be written using Fortran 95/2003 features. Avoid non-portable
vendor/compiler extensions.</p></li>
<li><p>When writing a <code class="docutils literal notranslate"><span class="pre">REAL</span></code> literal with an integer value, put a 0 after the
decimal point (i.e. 1.0 as opposed to 1.) to improve readability.</p></li>
<li><p>Avoid using obsolescent features of the Fortran language, instead make use of
F95/2003 alternatives. For example, statement functions are among the list
of deprecated features in the F95 standard and these can be replaced by
<code class="docutils literal notranslate"><span class="pre">FUNCTION</span></code>s within appropriate <code class="docutils literal notranslate"><span class="pre">MODULE</span></code>s.</p></li>
<li><p>Do not use archaic forms of intrinsic functions. For example, <code class="docutils literal notranslate"><span class="pre">LOG</span>
<span class="pre">()</span></code> should be used in place of <code class="docutils literal notranslate"><span class="pre">ALOG()</span></code>, <code class="docutils literal notranslate"><span class="pre">MAX()</span></code> instead of <code class="docutils literal notranslate"><span class="pre">AMAX1</span>
<span class="pre">()</span></code>, <code class="docutils literal notranslate"><span class="pre">REAL()</span></code> instead of <code class="docutils literal notranslate"><span class="pre">FLOAT()</span></code> etc.</p></li>
<li><p>Never use the <code class="docutils literal notranslate"><span class="pre">PAUSE</span></code> statement.</p></li>
<li><p>Never use the <code class="docutils literal notranslate"><span class="pre">STOP</span></code> statement, see <a class="reference internal" href="#s19">S19</a></p></li>
<li><p>The standard delimiter for namelists is <code class="docutils literal notranslate"><span class="pre">/</span></code>. In particular, note
that <code class="docutils literal notranslate"><span class="pre">&amp;END</span></code> is non-standard and should be avoided. For further information
on namelists please refer to <a class="reference internal" href="#namelists"><span class="std std-ref">Runtime namelist variables, defaults, future development</span></a>.</p></li>
<li><p>Only use the generic names of intrinsic functions, avoid the use of
‘hardware’ specific intrinsic functions. Use the latter if an only if
there is an optimisation benefit and then it must be protected by a
platform specific CPP flag <a class="reference internal" href="#s17">S17</a>.</p></li>
</ul>
</section>
<section id="s5-comments-and-white-spacing">
<span id="s5"></span><h3>S5. Comments and white spacing<a class="headerlink" href="#s5-comments-and-white-spacing" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Always comment code!</p></li>
<li><p>Start comments with a single <code class="docutils literal notranslate"><span class="pre">!</span></code>. The indention of whole line comments should
match that of the code.</p></li>
<li><p>Use spaces and blank lines where appropriate to format your code to improve
readability.</p></li>
<li><p>Never use tabs within UM code as the tab character is not in the Fortran
character set. If your editor inserts tabs automatically, you should
configure it to switch off the functionality when you are editing Fortran
source files.</p></li>
<li><p>Line up your statements, where appropriate, to improve readability.</p></li>
</ul>
</section>
<section id="s6-the-use-of-modules">
<span id="s6"></span><h3>S6. The use of modules<a class="headerlink" href="#s6-the-use-of-modules" title="Link to this heading">#</a></h3>
<p>MODULEs are strongly encouraged as the mainstay of future UM code program
units; making use of the implicit <code class="docutils literal notranslate"><span class="pre">INTERFACE</span></code> checking and removing the need
for the <code class="docutils literal notranslate"><span class="pre">!DEPENDS</span> <span class="pre">ON</span></code>. Argument lists within <code class="docutils literal notranslate"><span class="pre">SUBROUTINE</span></code> <code class="docutils literal notranslate"><span class="pre">CALLs</span></code> may
also shorten.</p>
<ul>
<li><p>You are expected to <code class="docutils literal notranslate"><span class="pre">USE</span> <span class="pre">&lt;module&gt;,</span> <span class="pre">ONLY</span> <span class="pre">:</span> <span class="pre">&lt;variables&gt;</span></code> and variables should
be imported from the module in which they were originally declared thus
enabling a code audit trail of variables around the UM code.</p></li>
<li><p>For code portability, be careful not to <code class="docutils literal notranslate"><span class="pre">USE</span> <span class="pre">&lt;module&gt;</span></code> twice in a routine
for the same MODULE, especially where using <code class="docutils literal notranslate"><span class="pre">ONLY</span></code>. This can lead to
compiler Warning and Error messages.</p></li>
<li><p>Where possible, module variables and procedures should be declared PRIVATE.
This avoids unnecessary export of symbols, promotes data hiding and may also
help the compiler to optimise the code.</p></li>
<li><p>The use of derived types is encouraged, to group related variables and their
use within Modules.</p></li>
<li><p>Review your use of arguments within subroutine calls, could some be
simplified by using Modules?</p></li>
<li><p>Before writing your Module, check the UM source that no one has already
created a Module to do what you want. For example do not declare a new
variable/parameter without checking if it is already available in a suitable
UM module.</p></li>
<li><p>Global type constants (e.g. <span class="math notranslate nohighlight">\(g\)</span> and <span class="math notranslate nohighlight">\(\pi\)</span>) should be maintained
at a high level within the UM code and not duplicated within modules at the
code section level; <code class="docutils literal notranslate"><span class="pre">USE</span> <span class="pre">&lt;insert</span> <span class="pre">global</span> <span class="pre">consts</span> <span class="pre">module</span> <span class="pre">name</span> <span class="pre">here&gt;</span></code> instead.
Only section specific constants should be maintained at the section level.</p></li>
<li><p>When calling another Subroutine or an External Function the use of
<code class="docutils literal notranslate"><span class="pre">!</span> <span class="pre">DEPENDS</span> <span class="pre">ON</span></code> directive is required within the Unified Model prior to
the <code class="docutils literal notranslate"><span class="pre">CALL</span></code> unless the Subroutine or Function is wrapped within a Module;
thus USE it,</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">! DEPENDS ON: gather_field_gcom</span>
<span class="k">CALL </span><span class="n">gather_field_gcom</span><span class="p">(</span><span class="n">local_field</span><span class="p">,</span><span class="w">    </span><span class="n">global_field</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span>
<span class="w">                       </span><span class="n">local_row_len</span><span class="p">,</span><span class="w">  </span><span class="n">local_rows</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span>
<span class="w">                       </span><span class="n">global_row_len</span><span class="p">,</span><span class="w"> </span><span class="n">global_rows</span><span class="p">,</span><span class="w">        </span><span class="p">&amp;</span>
<span class="w">                       </span><span class="n">grid_type</span><span class="p">,</span><span class="w">      </span><span class="n">halo_type</span><span class="p">,</span><span class="w">          </span><span class="p">&amp;</span>
<span class="w">                       </span><span class="n">gather_pe</span><span class="p">,</span><span class="w">      </span><span class="n">proc_group</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span>
<span class="w">                       </span><span class="n">icode</span><span class="p">,</span><span class="w">          </span><span class="n">cmessage</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Avoid the introduction of additional <code class="docutils literal notranslate"><span class="pre">COMMON</span></code> blocks. Developers
should now be using <code class="docutils literal notranslate"><span class="pre">MODULE</span></code>s.</p></li>
</ul>
</section>
<section id="s7-argument-and-variable-declaration">
<span id="s7"></span><h3>S7. Argument and variable declaration<a class="headerlink" href="#s7-argument-and-variable-declaration" title="Link to this heading">#</a></h3>
<ul>
<li><p>Use IMPLICIT NONE in all program units. This forces you to declare all your
variables explicitly. This helps to reduce bugs in your program that will
otherwise be difficult to track.</p></li>
<li><p>Use meaningful variable names to aid code comprehension.</p></li>
<li><p>Variables should not use Fortran keywords or intrinsic functions for their
name. For example, a variable should not be named <code class="docutils literal notranslate"><span class="pre">size</span></code>, because there is
already a Fortran intrinsic function called <code class="docutils literal notranslate"><span class="pre">SIZE()</span></code></p></li>
<li><p>For the purposes of variable naming, “Fortran keywords or intrinsic
functions” shall refer to the set of all keywords and functions, from all
Fortran Standard versions (including all past and future versions, not just
Fortran 2003). For, example, the <code class="docutils literal notranslate"><span class="pre">ASSIGN</span></code> keyword was deleted in Fortran
95, but <code class="docutils literal notranslate"><span class="pre">assign</span></code> still should not be used as a variable name.</p></li>
<li><p>All variables must be declared, and commented with a brief description. This
increases understandability and reduces errors caused by misspellings of
variables.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">INTENT</span></code> in declaring arguments as this allows for checks to be done at
compile time.</p></li>
<li><p>Arguments should be declared separately from local variables.</p></li>
<li><p>Subroutine arguments should be declared in the same order in the header as
they appear in the subroutine statement. This order is not random but is
determined by intent, variable dimensions and variable type. All input
arguments come first, followed by all input/output arguments and then all
output arguments. The exception being any <code class="docutils literal notranslate"><span class="pre">OPTIONAL</span></code> arguments which
should be appended to the end of the argument list. If more than one
<code class="docutils literal notranslate"><span class="pre">OPTIONAL</span></code> argument is used then one should also use keywords so that the
<code class="docutils literal notranslate"><span class="pre">OPTIONAL</span></code> arguments are not tied to a specific ‘position’ near the end of
the argument list.</p></li>
<li><p>As <code class="docutils literal notranslate"><span class="pre">OPTIONAL</span></code> arguments are possible when using <code class="docutils literal notranslate"><span class="pre">MODULE</span></code>s (an interface
is required) there is no requirement in future for DUMMY arguments and glue
routines.</p></li>
<li><p>It is recommended that one uses local variables in routines which are set to
the values of optional arguments in the code if present, otherwise a default
value is used. This removes the requirement to always use <code class="docutils literal notranslate"><span class="pre">PRESENT</span></code> when
using the optional argument.</p></li>
<li><p>Within each section of the header, variables of a given type should be
grouped together. These groups must be declared in the order <code class="docutils literal notranslate"><span class="pre">INTEGER</span></code>,
<code class="docutils literal notranslate"><span class="pre">REAL</span></code>, <code class="docutils literal notranslate"><span class="pre">LOGICAL</span></code> and then <code class="docutils literal notranslate"><span class="pre">CHARACTER</span></code>, with each grouping separated
by a blank line. In general variables should be declared one per line. Use a
separate type statement for each line as this makes it easier to copy code
around (you can always use the editor to repeat a line to save typing the
type statement again) and prevents you from running out of continuation
lines.</p></li>
<li><p>If an array is dimensioned by another variable, ensure that the variable is
declared first.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">EXTERNAL</span></code> statement should not be used for subroutines although it is
allowed for functions, again for code portability.</p></li>
<li><p>Avoid the <code class="docutils literal notranslate"><span class="pre">DIMENSION</span></code> attribute or statement. Declare the dimension with
the declared variables which improves readability.</p>
<p>Common practice</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="kt">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="k">DIMENSION</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>
</pre></div>
</div>
<p>Better approach</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="kt">INTEGER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">),</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">),</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Initialisation in the declaration of a variable should only be done after
considering whether it is to be only initialised on the first encounter of
the variable or not. Fortran automatically adds <code class="docutils literal notranslate"><span class="pre">SAVE</span></code> to the declaration
attribute to this type of initialisation. This is especially important in
OpenMP and when you expect the variable to be reset everytime the routine is
entered. <code class="docutils literal notranslate"><span class="pre">POINTER</span></code>s are also affected so please be aware of the
effects.</p></li>
<li><p>Character strings must be declared with a length when stored in an array.</p></li>
<li><p>If an argument list has a dummy argument that makes use of incoming data
(whether or not it has an explicit <code class="docutils literal notranslate"><span class="pre">INTENT</span></code>) and another argument
explicitly declared <code class="docutils literal notranslate"><span class="pre">INTENT(OUT)</span></code>, do not use the same variable as the
actual argument to both dummy arguments (“aliasing”). Some compilers will
reinitialise all <code class="docutils literal notranslate"><span class="pre">INTENT(OUT)</span></code> variables on entry, destroying the incoming
data.</p>
<p>Example subroutine:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">SUBROUTINE </span><span class="n">foo</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">m</span>
<span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span>
</pre></div>
</div>
<p>Bad practice:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">CALL </span><span class="n">foo</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<p>Safe approach:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span>
<span class="k">CALL </span><span class="n">foo</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="s8-allocatables">
<span id="s8"></span><h3>S8. Allocatables<a class="headerlink" href="#s8-allocatables" title="Link to this heading">#</a></h3>
<ul>
<li><p>When Allocating and deallocating, use a separate ALLOCATE and DEALLOCATE
statement for each array.</p></li>
<li><p>When using the <code class="docutils literal notranslate"><span class="pre">ALLOCATE</span></code> statement, ensure that any arrays passed to
subroutines have been allocated, even if it’s anticipated that they won’t be
used.</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">L_mcr_qrain</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">  ALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mix_rain_phys2</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">offx</span><span class="p">:</span><span class="n">row_length</span><span class="o">+</span><span class="n">offx</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="mi">1</span><span class="o">-</span><span class="n">offy</span><span class="p">:</span><span class="n">rows</span><span class="o">+</span><span class="n">offy</span><span class="p">,</span><span class="w"> </span><span class="n">wet_levels</span><span class="p">)</span>
<span class="k">ELSE</span>
<span class="k">  ALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mix_rain_phys2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="k">END IF</span>

<span class="c">! DEPENDS ON: q_to_mix</span>
<span class="k">CALL </span><span class="n">do_something</span><span class="p">(</span><span class="n">row_length</span><span class="p">,</span><span class="w"> </span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="n">wet_levels</span><span class="p">,</span><span class="w">             </span><span class="p">&amp;</span>
<span class="w">                  </span><span class="n">offx</span><span class="p">,</span><span class="n">offy</span><span class="p">,</span><span class="w"> </span><span class="n">mix_rain_phys2</span><span class="w">   </span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>To prevent memory fragmentation ensure that allocates and deallocates match
in reverse order.</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">ALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">row_length</span><span class="p">,</span><span class="n">rows</span><span class="p">,</span><span class="n">levels</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="k">ALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="n">row_length</span><span class="p">,</span><span class="n">rows</span><span class="p">,</span><span class="n">levels</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="k">ALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">(</span><span class="n">row_length</span><span class="p">,</span><span class="n">rows</span><span class="p">,</span><span class="n">levels</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="p">....</span>
<span class="k">DEALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="p">)</span>
<span class="k">DEALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="p">)</span>
<span class="k">DEALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Where possible, an ALLOCATE statement for an ALLOCATABLE array (or a POINTER
used as a dynamic array) should be coupled with a DEALLOCATE within the same
scope. If an ALLOCATABLE array is a PUBLIC MODULE variable, it is highly
desirable for its memory allocation and deallocation to be only performed in
procedures within the MODULE in which it is declared. You may consider
writing specific SUBROUTINEs within the MODULE to handle these memory
managements.</p></li>
<li><p>Always define a POINTER before using it. You can define a POINTER in its
declaration by pointing it to the intrinsic function NULL() (also see advice
in <a class="reference internal" href="#s7">S7</a>). Alternatively, you can make sure that your POINTER is defined or
nullified early on in the program unit. Similarly, NULLIFY a POINTER when it
is no longer in use, either by using the NULLIFY statement or by pointing
your POINTER to NULL().</p></li>
<li><p>New operators can be defined within an <code class="docutils literal notranslate"><span class="pre">INTERFACE</span></code> block.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ASSOCIATED</span></code> should only be done on initialised pointers.
Uninitialised pointers are undefined and <code class="docutils literal notranslate"><span class="pre">ASSOCIATED</span></code> can have
different effects on different platforms.</p></li>
</ul>
</section>
<section id="s9-code-if-blocks-do-loops-and-other-constructs">
<span id="s9"></span><h3>S9. Code IF blocks, DO LOOPs, and other constructs<a class="headerlink" href="#s9-code-if-blocks-do-loops-and-other-constructs" title="Link to this heading">#</a></h3>
<ul>
<li><p>The use of comments is required for both large <code class="docutils literal notranslate"><span class="pre">DO</span></code> loops and large
<code class="docutils literal notranslate"><span class="pre">IF</span></code> blocks; those spanning 15 lines or more, see <a class="reference internal" href="#s5">S5</a>.</p></li>
<li><p>Indent blocks of code by 2 characters.</p></li>
<li><p>Use the newer forms of the relational operators for LOGICAL
comparisons:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">instead</span> <span class="n">of</span> <span class="o">.</span><span class="n">EQ</span><span class="o">.</span>
<span class="o">/=</span> <span class="n">instead</span> <span class="n">of</span> <span class="o">.</span><span class="n">NE</span><span class="o">.</span>
<span class="o">&gt;</span>  <span class="n">instead</span> <span class="n">of</span> <span class="o">.</span><span class="n">GT</span><span class="o">.</span>
<span class="o">&lt;</span>  <span class="n">instead</span> <span class="n">of</span> <span class="o">.</span><span class="n">LT</span><span class="o">.</span>
<span class="o">&gt;=</span> <span class="n">instead</span> <span class="n">of</span> <span class="o">.</span><span class="n">GE</span><span class="o">.</span> <span class="p">(</span><span class="n">do</span> <span class="ow">not</span> <span class="n">use</span> <span class="o">=&gt;</span><span class="p">)</span>
<span class="o">&lt;=</span> <span class="n">instead</span> <span class="n">of</span> <span class="o">.</span><span class="n">LE</span><span class="o">.</span> <span class="p">(</span><span class="n">do</span> <span class="ow">not</span> <span class="n">use</span> <span class="o">=&lt;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Positive logic is usually easier to understand. When using an IF-ELSE-END IF
construct you should use positive logic in the IF test, provided that the
positive and the negative blocks are about the same length.</p>
<p>Common practice</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">my_var</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">some_value</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">  CALL </span><span class="n">do_this</span><span class="p">()</span>
<span class="k">ELSE</span>
<span class="k">  CALL </span><span class="n">do_that</span><span class="p">()</span>
<span class="k">END IF</span>
</pre></div>
</div>
<p>Better approach</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">my_var</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">some_value</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">  CALL </span><span class="n">do_that</span><span class="p">()</span>
<span class="k">ELSE</span>
<span class="k">  CALL </span><span class="n">do_this</span><span class="p">()</span>
<span class="k">END IF</span>
</pre></div>
</div>
</li>
<li><p>Where appropriate, simplify your LOGICAL assignments, for example:</p>
<div class="samepage docutils container">
<p>Common practice</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">my_var</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">some_value</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">  </span><span class="n">something</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<span class="w">  </span><span class="n">something_else</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span>
<span class="k">ELSE</span>
<span class="k">  </span><span class="n">something</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span>
<span class="w">  </span><span class="n">something_else</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<span class="k">END IF</span>
<span class="c">! ...</span>
<span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">something</span><span class="w"> </span><span class="p">.</span><span class="n">EQV</span><span class="p">.</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">  CALL </span><span class="n">do_something</span><span class="p">()</span>
<span class="w">  </span><span class="c">! ...</span>
<span class="k">END IF</span>
</pre></div>
</div>
</div>
<div class="samepage docutils container">
<p>Better approach</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="n">something</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">my_var</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">some_value</span><span class="p">)</span>
<span class="n">something_else</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">my_var</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">some_value</span><span class="p">)</span>
<span class="c">! ...</span>
<span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">something</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">  CALL </span><span class="n">do_something</span><span class="p">()</span>
<span class="w">  </span><span class="c">! ...</span>
<span class="k">END IF</span>
</pre></div>
</div>
</div>
</li>
<li><p>Avoid the use of ‘magic numbers’ that is numeric constants hard wired into
the code. These are very hard to maintain and obscure the function of the
code. It is much better to assign the ‘magic number’ to a variable or
constant with a meaningful name and then to use this throughout the code. In
many cases the variable will be assigned in a top level control routine and
passed down via a include file or module. This ensures that all subroutines
will use the correct value of the numeric constant and that alteration of it
in one place will be propagated to all its occurrences. Unless the value
needs to be alterable whilst the program is running (e.g. is altered via I/O
such as a namelist) the assignment should be made using a <code class="docutils literal notranslate"><span class="pre">PARAMETER</span></code>
statement.</p>
<div class="samepage docutils container">
<p>Poor Practice</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ObsType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
</pre></div>
</div>
</div>
<div class="samepage docutils container">
<p>Better Approach</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="p">...</span><span class="n">specify</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="n">section</span><span class="p">....</span>

<span class="kt">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="k">PARAMETER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">SurfaceWind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="c">!No. for surface wind</span>

<span class="p">...</span><span class="nb">and </span><span class="k">then use </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="kt">logical </span><span class="n">code</span><span class="p">...</span>

<span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ObsType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SurfaceWind</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
</pre></div>
</div>
</div>
</li>
<li><p>Similarly avoid the use of ‘magic logicals’ in CALLs to subroutines. Such use
makes the code less readable and developers are required to look at the
called subroutine to find what has been set to either <code class="docutils literal notranslate"><span class="pre">.TRUE.</span></code> or
<code class="docutils literal notranslate"><span class="pre">.FALSE.</span></code>.</p>
<div class="samepage docutils container">
<p>Poor Practice</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">CALL </span><span class="n">Phys</span><span class="p">(.</span><span class="n">FALSE</span><span class="p">.,.</span><span class="n">TRUE</span><span class="p">.,</span><span class="n">icode</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="samepage docutils container">
<p>Better Approach</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="p">...</span><span class="n">specify</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="n">section</span><span class="p">....</span>
<span class="p">...</span><span class="n">meaningful</span><span class="w"> </span><span class="kt">logical </span><span class="n">names</span><span class="p">,</span><span class="w"> </span><span class="n">perhaps</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">them</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="k">is </span><span class="n">used</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="k">subroutine</span>

<span class="kt">LOGICAL</span><span class="p">,</span><span class="w"> </span><span class="k">PARAMETER</span><span class="w"> </span><span class="kd">::</span><span class="w">  </span><span class="n">bl_is_off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span>
<span class="kt">LOGICAL</span><span class="p">,</span><span class="w"> </span><span class="k">PARAMETER</span><span class="w"> </span><span class="kd">::</span><span class="w">  </span><span class="n">conv_is_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>

<span class="p">...</span><span class="nb">and </span><span class="k">then use </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">relevant</span><span class="w"> </span><span class="k">subroutine </span><span class="n">calls</span><span class="p">...</span>

<span class="k">CALL </span><span class="n">Phys</span><span class="p">(</span><span class="n">bl_is_off</span><span class="p">,</span><span class="w"> </span><span class="n">conv_is_on</span><span class="p">,</span><span class="w"> </span><span class="n">icode</span><span class="p">)</span>
</pre></div>
</div>
</div>
</li>
<li><p><strong>Be careful</strong> when comparing real numbers using <code class="docutils literal notranslate"><span class="pre">==</span></code>. To avoid problems
related to machine precision, a threshold on the difference between the
two numbers is often preferable, e.g.</p>
<div class="samepage docutils container">
<p>Common practice</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">real1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">real2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">  </span><span class="p">...</span>
<span class="k">END IF</span>
</pre></div>
</div>
</div>
<div class="samepage docutils container">
<p>Better approach</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">ABS</span><span class="p">(</span><span class="n">real1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">real2</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">small_number</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">  </span><span class="p">...</span>
<span class="k">END IF</span>
</pre></div>
</div>
</div>
<p>where small_number is some suitably small number. In most cases, a suitable
value for small_number can be obtained using the Fortran intrinsic functions
<code class="docutils literal notranslate"><span class="pre">EPSILON</span></code> or <code class="docutils literal notranslate"><span class="pre">TINY</span></code>.</p>
<p>The UM perturbation sensitivity project is currently in the process of
identifying coding issues that lead to excessive perturbation growth in
the model. Currently, all problems are emerging at IF tests that contain
comparisons between real numbers. Typical, real case UM examples of what
can go wrong are detailed in <a class="reference internal" href="#appendix-c">Appendix C</a> of this document.</p>
</li>
<li><p>Loops <em>must</em> terminate with an <code class="docutils literal notranslate"><span class="pre">END</span> <span class="pre">DO</span></code> statement. To improve the clarity
of program structure you are encouraged to add labels or comments to the
<code class="docutils literal notranslate"><span class="pre">DO</span></code> and <code class="docutils literal notranslate"><span class="pre">END</span> <span class="pre">DO</span></code> statements.</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">DO </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span>
<span class="w">  </span><span class="n">j_loop</span><span class="p">:</span><span class="w"> </span><span class="k">DO </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span>
<span class="w">    </span><span class="k">DO </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span>
<span class="w">      </span><span class="p">...</span><span class="n">code</span><span class="w"> </span><span class="n">statements</span><span class="p">...</span>
<span class="w">    </span><span class="k">END DO</span><span class="w"> </span><span class="c">! k</span>
<span class="w">  </span><span class="k">END DO </span><span class="n">j_loop</span>
<span class="k">END DO</span><span class="w"> </span><span class="c">! outer loop i</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">EXIT</span></code> statements <em>must</em> be labelled. This is both for clarity, and to
ensure consistency of behaviour. (The semantics of the <code class="docutils literal notranslate"><span class="pre">EXIT</span></code> statement
changes between revisions of the Fortran standard.)</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="n">i_loop</span><span class="p">:</span><span class="w"> </span><span class="k">DO </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span>
<span class="w">  </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">EXIT </span><span class="n">i_loop</span>
<span class="k">END DO </span><span class="n">i_loop</span>
</pre></div>
</div>
</li>
<li><p>Avoid the use of the <code class="docutils literal notranslate"><span class="pre">GO</span> <span class="pre">TO</span></code> statement.</p>
<ul class="simple">
<li><p>The only acceptable use of <code class="docutils literal notranslate"><span class="pre">GO</span> <span class="pre">TO</span></code> is to jump to the end of a routine
after the detection of an error, in which case you must use <code class="docutils literal notranslate"><span class="pre">9999</span></code> as
the label (then everyone will understand what <code class="docutils literal notranslate"><span class="pre">GO</span> <span class="pre">TO</span> <span class="pre">9999</span></code> means).</p></li>
<li><p>UM Error reporting guidance is detailed in <a class="reference internal" href="#s19">S19</a></p></li>
</ul>
</li>
<li><p>Avoid assigned <code class="docutils literal notranslate"><span class="pre">GO</span> <span class="pre">TO</span></code>, computed <code class="docutils literal notranslate"><span class="pre">GO</span> <span class="pre">TO</span></code>, arithmetic <code class="docutils literal notranslate"><span class="pre">IF</span></code>, etc. Use the
appropriate modern constructs such as <code class="docutils literal notranslate"><span class="pre">IF</span></code>, <code class="docutils literal notranslate"><span class="pre">WHERE</span></code>, <code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">CASE</span></code>,
etc..</p></li>
<li><p>Where possible, consider using <code class="docutils literal notranslate"><span class="pre">CYCLE</span></code>, <code class="docutils literal notranslate"><span class="pre">EXIT</span></code> or a <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> construct
to simplify complicated <code class="docutils literal notranslate"><span class="pre">DO</span></code> loops.</p></li>
<li><p>Be aware that logic in <code class="docutils literal notranslate"><span class="pre">IF</span></code> conditions can be performed in any order. So
checking that array is greater than lower bound and using that index is not
safe.</p>
<p>Common approach</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">DO </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows</span>
<span class="w">  </span><span class="k">DO </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">row_length</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">cloud_level</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">AND</span><span class="p">.</span><span class="w"> </span><span class="n">cloud</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">cloud_level</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">      </span><span class="n">cloud</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">cloud_level</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">    </span><span class="k">END IF</span>
<span class="k">  END DO</span>
<span class="k">END DO</span>
</pre></div>
</div>
<p>Better approach</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">DO </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows</span>
<span class="w">  </span><span class="k">DO </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">row_length</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">cloud_level</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">      IF</span><span class="w"> </span><span class="p">(</span><span class="n">cloud</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">cloud_level</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">        </span><span class="n">cloud</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">cloud_level</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">      </span><span class="k">END IF</span>
<span class="k">    END IF</span>
<span class="k">  END DO</span>
<span class="k">END DO</span>
</pre></div>
</div>
</li>
<li><p>Array initialisations and literals should use the <code class="docutils literal notranslate"><span class="pre">[]</span></code> form rather than the
<code class="docutils literal notranslate"><span class="pre">(//)</span></code> form. For example:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="kt">INTEGER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i_array</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="s10-line-continuation">
<span id="s10"></span><h3>S10. Line continuation<a class="headerlink" href="#s10-line-continuation" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The only symbol to be used as a continuation line marker is ‘<code class="docutils literal notranslate"><span class="pre">&amp;</span></code>’ at the
end of a line. It is suggested that you align these continuation markers to
aid readability. Do not add a second ‘<code class="docutils literal notranslate"><span class="pre">&amp;</span></code>’ to the beginning of the next
line. This advice also applies to blocks of Fortran code protected by the
OpenMP sentinel ‘<code class="docutils literal notranslate"><span class="pre">!$</span></code>’. The only currently allowed exception is to
continuation lines used with OpenMP directives, i.e. ‘<code class="docutils literal notranslate"><span class="pre">!$OMP</span></code>’, where
the ‘<code class="docutils literal notranslate"><span class="pre">&amp;</span></code>’ marker may optionally be used. Please see section <a class="reference internal" href="#s15">S15</a> for
more advice on OpenMP.</p></li>
<li><p>Short and simple Fortran statements are easier to read and understand than
long and complex ones. Where possible, avoid using continuation lines in a
statement.</p></li>
<li><p>Try to avoid string continuations and spread the string across multiple lines
using concatenations (<code class="docutils literal notranslate"><span class="pre">//</span></code>) instead.</p></li>
<li><p>When calling functions or subroutines, ensure the left parenthesis is on the
same line as the subprogram’s name, and not after a continuation marker.
This helps the code browser to parse the source tree correctly.</p></li>
</ul>
</section>
<section id="s11-fortran-i-o">
<span id="s11"></span><h3>S11. Fortran I/O<a class="headerlink" href="#s11-fortran-i-o" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>When calling <code class="docutils literal notranslate"><span class="pre">OPEN</span></code>, ensure that the <code class="docutils literal notranslate"><span class="pre">ACTION</span></code> argument is specified. In
particular, <code class="docutils literal notranslate"><span class="pre">ACTION='READ'</span></code> shall be used for files that are opened only
for reading as this reduces file locking costs.</p></li>
<li><p>Don’t check for the existence of a file by using <code class="docutils literal notranslate"><span class="pre">INQUIRE</span></code> if the only
action you’ll take if the file doesn’t exist is to report an error. Rather
use <code class="docutils literal notranslate"><span class="pre">OPEN(</span> <span class="pre">...</span> <span class="pre">,</span> <span class="pre">IOSTAT=icode,</span> <span class="pre">IOMSG=iomessage)</span></code> and include the
<code class="docutils literal notranslate"><span class="pre">iomessage</span></code> in an error message if <code class="docutils literal notranslate"><span class="pre">icode</span></code> is non-zero. This will
capture a wider range of errors with fewer filesystem metadata accesses.</p></li>
</ul>
</section>
<section id="s12-formatting-and-output-of-text">
<span id="s12"></span><h3>S12. Formatting and output of text<a class="headerlink" href="#s12-formatting-and-output-of-text" title="Link to this heading">#</a></h3>
<p>Writing output to the “stdout” stream, commonly unit 6 in fortran must use the
provided API, which is accessible by including <code class="docutils literal notranslate"><span class="pre">USE</span> <span class="pre">umPrintMgr</span></code> in the
calling code.</p>
<ul>
<li><p>Single string output should be written as</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">CALL </span><span class="n">umprint</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">,</span><span class="n">src</span><span class="o">=</span><span class="s1">&#39;routine_name&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>where ‘routine_name’ is the name of the current subroutine or function.
Routines which implement DrHook (section <a class="reference internal" href="#s14">S14</a>) will already have a
<code class="docutils literal notranslate"><span class="pre">PARAMETER</span> <span class="pre">'RoutineName'</span></code> which can be used for this
purpose.</p>
</li>
<li><p>Multi-component output must first be written to an internal file via
<code class="docutils literal notranslate"><span class="pre">WRITE</span></code> statement. The <code class="docutils literal notranslate"><span class="pre">umPrintMgr</span></code> module provides a convenient string
for this purpose; <code class="docutils literal notranslate"><span class="pre">umMessage</span></code>, though you may use your own.</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">WRITE</span><span class="w"> </span><span class="p">(</span><span class="n">ummessage</span><span class="p">,</span><span class="s1">&#39;(A,I0,A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;I am &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; years old&#39;</span>
<span class="k">CALL </span><span class="n">umprint</span><span class="p">(</span><span class="n">ummessage</span><span class="p">,</span><span class="n">src</span><span class="o">=</span><span class="s1">&#39;routine_name&#39;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Avoid the use of <code class="docutils literal notranslate"><span class="pre">WRITE</span> <span class="pre">(ummessage,*)</span></code></p></li>
<li><p>Always add formatting information to your write statements. It is important
to ensure that the output message fits within the space given. Some
compilers will pad unformatted values with leading blanks, which can greatly
increase the width of any output. Writes to internal files may cause the
program to abort if the message is longer than the string provided.</p></li>
<li><p>Use dynamic-width edit descriptors where possible, to avoid truncating
strings or failing to print integer or real values correctly:</p>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">A</span></code> for character input and output, rather than e.g. <code class="docutils literal notranslate"><span class="pre">A7</span></code>.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">I0</span></code> for integer output, rather than e.g. <code class="docutils literal notranslate"><span class="pre">I3</span></code>.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">F0.</span></code><span class="math notranslate nohighlight">\(n\)</span> for real output, rather than e.g.
<code class="docutils literal notranslate"><span class="pre">F14.</span></code><span class="math notranslate nohighlight">\(n\)</span>. Other real edit descriptors such as <code class="docutils literal notranslate"><span class="pre">E</span></code>, <code class="docutils literal notranslate"><span class="pre">EN</span></code> and
<code class="docutils literal notranslate"><span class="pre">ES</span></code> can also be used but do not accept a 0 field width.</p></li>
</ul>
<p>This is particularly important in any routine where missing data indicators
may be present, which will typically require a much larger width than other
data.</p>
</li>
<li><p>The character variable <code class="docutils literal notranslate"><span class="pre">newline</span></code> (from the <code class="docutils literal notranslate"><span class="pre">umPrintmgr</span></code> module) is
recognised as a newline if embedded in the string passed to <code class="docutils literal notranslate"><span class="pre">umPrint</span></code>.</p></li>
<li><p>The total line length should not exceed 80 characters. Use <code class="docutils literal notranslate"><span class="pre">newline</span></code> or
separate calls to <code class="docutils literal notranslate"><span class="pre">umprint</span></code> to keep long messages easily readable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CHARACTER</span></code> values should not contain vertical space, nor should edit
descriptors be used for carriage control. Use <code class="docutils literal notranslate"><span class="pre">newline</span></code> to control
vertical space:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">WRITE</span><span class="p">(</span><span class="n">ummessage</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">newline</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="s1">&#39;This should stand out.&#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">newline</span>
<span class="k">CALL </span><span class="n">umprint</span><span class="p">(</span><span class="n">ummessage</span><span class="p">,</span><span class="n">src</span><span class="o">=</span><span class="s1">&#39;routine_name&#39;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Calls to <code class="docutils literal notranslate"><span class="pre">umPrint</span></code> should be protected by a suitable setting of the
PrintStatus variable, see <a class="reference internal" href="#s13">S13</a> either with conditional logic or an
additional <code class="docutils literal notranslate"><span class="pre">level</span></code> argument,</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">CALL </span><span class="n">umprint</span><span class="p">(</span><span class="n">ummessage</span><span class="p">,</span><span class="n">src</span><span class="o">=</span><span class="s1">&#39;routine_name&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">PrOper</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>If your output is not required from each processor protect the <code class="docutils literal notranslate"><span class="pre">umPrint</span></code>
either with logic, or an additional <code class="docutils literal notranslate"><span class="pre">pe</span></code> argument, for example,</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">! We&#39;ll only output at diagnostic level on pe0</span>
<span class="k">CALL </span><span class="n">umprint</span><span class="p">(</span><span class="n">ummessage</span><span class="p">,</span><span class="n">src</span><span class="o">=</span><span class="s1">&#39;routine_name&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">PrDiag</span><span class="p">,</span><span class="n">pe</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Never use a <code class="docutils literal notranslate"><span class="pre">FORMAT</span></code> statement: they require the use of labels, and obscure
the meaning of the I/O statement. The formatting information can be placed
explicitly within the <code class="docutils literal notranslate"><span class="pre">READ</span></code>, <code class="docutils literal notranslate"><span class="pre">WRITE</span></code> or <code class="docutils literal notranslate"><span class="pre">PRINT</span></code> statement, or be
assigned to a <code class="docutils literal notranslate"><span class="pre">CHARACTER</span></code> variable in a <code class="docutils literal notranslate"><span class="pre">PARAMETER</span></code> statement in the
header of the routine for later use in I/O statements. Never place output
text within the format specifier: i.e. only format information may be placed
within the <code class="docutils literal notranslate"><span class="pre">FMT=</span></code> part of an I/O statement, all variables and literals,
including any character literals, must be ‘arguments’ of the I/O routine
itself. This improves readability by clearly separating what is to be
read/written from how to read/write it.</p>
<p>Common practice</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="k">WRITE</span><span class="p">(</span><span class="n">Cmessage</span><span class="p">,</span><span class="w">                                                 </span><span class="p">&amp;</span>
<span class="p">&amp;</span><span class="w">    </span><span class="s1">&#39;(&quot;Cannot run with decomposition &quot;,I3,&quot; x &quot;,I3,             &amp;</span>
<span class="s1">&amp;      &quot; (&quot;,I3,&quot;) processors. &quot;,                                 &amp;</span>
<span class="s1">&amp;      &quot;Maxproc is &quot;,I3,&quot; processors.&quot;)&#39;</span><span class="p">)</span><span class="w">                        </span><span class="p">&amp;</span>
<span class="p">&amp;</span><span class="w">       </span><span class="n">nproc_EW</span><span class="p">,</span><span class="n">nproc_NS</span><span class="p">,</span><span class="n">nproc_EW</span><span class="o">*</span><span class="n">nproc_NS</span><span class="p">,</span><span class="n">Maxproc</span>
</pre></div>
</div>
<p>Better approach</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">WRITE</span><span class="p">(</span><span class="n">cmessage</span><span class="p">,</span><span class="s1">&#39;(4(A,I0),A)&#39;</span><span class="p">)</span><span class="w">                                 </span><span class="p">&amp;</span>
<span class="w">   </span><span class="s1">&#39;Cannot run with decomposition &#39;</span><span class="p">,</span><span class="n">nproc_ew</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">nproc_ns</span><span class="p">,</span><span class="w">    </span><span class="p">&amp;</span>
<span class="w">   </span><span class="s1">&#39;(&#39;</span><span class="p">,</span><span class="n">nproc_ew</span><span class="o">*</span><span class="n">nproc_ns</span><span class="p">,</span><span class="s1">&#39;) processors. Maxproc is &#39;</span><span class="p">,</span><span class="n">maxproc</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">   </span><span class="s1">&#39; processors.&#39;</span>
</pre></div>
</div>
</li>
<li><p>In order to flush output buffers, the routine <code class="docutils literal notranslate"><span class="pre">umprintflush</span></code> should be used
for “stdout” written via <code class="docutils literal notranslate"><span class="pre">umprint</span></code> and <code class="docutils literal notranslate"><span class="pre">UM_FORT_FLUSH</span></code> for data writtent
to any other fortran unit. These routines abstract flush operations
providing a portable interface. These are the only method of flushing that
should be used.</p></li>
</ul>
</section>
<section id="s13-printstatus">
<span id="s13"></span><h3>S13. PrintStatus<a class="headerlink" href="#s13-printstatus" title="Link to this heading">#</a></h3>
<p>There are four different settings of PrintStatus used in the UM, each of which
is assigned a numeric value. There is a shorter form available for each one.
These are defined as <code class="docutils literal notranslate"><span class="pre">PARAMETER</span></code>s and so can be tested using constructs
similar to:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">PrintStatus</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">PrStatus_Normal</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
</pre></div>
</div>
<p>For “stdout”, they can also be provided as an argument to <code class="docutils literal notranslate"><span class="pre">umprint</span></code>. The
current value of PrintStatus is stored in the variable <code class="docutils literal notranslate"><span class="pre">PrintStatus</span></code> in the
aforementioned module, and set using the gui and/or input namelist. Note that
the utility executables operate at a fixed value of <code class="docutils literal notranslate"><span class="pre">PrintStatus</span></code> and that
output choices in code shared with these utilities will impact their
behaviour.</p>
<p>The different settings are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PrStatus_Min</span></code> or <code class="docutils literal notranslate"><span class="pre">PrMin</span></code> - This setting is intended to produce minimal
output and should hence be only used for output which is required in every
run. Users running with this setting should expect to have to rerun with a
more verbose setting to diagnose any problems. Fatal error messages should
fall into this category, but otherwise it should not generally be used by
developers.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PrStatus_Normal</span></code> or <code class="docutils literal notranslate"><span class="pre">PrNorm</span></code> - The “standard” setting of PrintStatus.
Messages with this setting should be important for all users in every run.
Information output using this setting should summarise the situation - more
detailed information should be protected by <code class="docutils literal notranslate"><span class="pre">PrStatus_Diag</span></code> instead.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PrStatus_Oper</span></code> or <code class="docutils literal notranslate"><span class="pre">PrOper</span></code>- Slightly more detailed than
<code class="docutils literal notranslate"><span class="pre">PrStatus_Normal</span></code>, this is intended for messages which are not required
for research users but are needed when running operationally.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PrStatus_Diag</span></code> or or <code class="docutils literal notranslate"><span class="pre">PrDiag</span></code> - The most verbose option, all messages
which do not fall into one of the above categories should use this setting.
Non-essential, detailed information about values of variables, status
messages, etc should be included in this category. If a developer adds code
to assist debugging problems, it should also be protected by
<code class="docutils literal notranslate"><span class="pre">PrStatus_Diag</span></code>.</p></li>
</ul>
</section>
<section id="s14-drhook">
<span id="s14"></span><h3>S14. DrHook<a class="headerlink" href="#s14-drhook" title="Link to this heading">#</a></h3>
<p>DrHook is a library written by ECMWF which can produce run-time information
such as:</p>
<ul class="simple">
<li><p>Per-routine profiling information based on walltime, CPU-time and MFlops.</p></li>
<li><p>Tracebacks in the event of code failure. A developer can force a traceback at
any point in the code with an appropriate call to the DrHook library.</p></li>
<li><p>Memory usage information.</p></li>
</ul>
<p>For DrHook to be effective, calls to the library are needed in each individual
subroutine. DrHook must be called:</p>
<ol class="arabic simple">
<li><p>At the start of each routine, before any other executable code.</p></li>
<li><p>At each exit point from the routine; not only at the end, but just before
any other <code class="docutils literal notranslate"><span class="pre">RETURN</span></code> statements.</p></li>
</ol>
<p>When adding DrHook to a routine, the following rules should be followed:</p>
<ul class="simple">
<li><p>Routines contained in modules should include the name of the module in the
call to DrHook, colon-separated. E.g. <code class="docutils literal notranslate"><span class="pre">'MODULE_NAME:ROUTINE_NAME'</span></code>.</p></li>
<li><p>All names should be in capitals.</p></li>
</ul>
<p>The necessary instrumentation code and the recommended method of implementing
it is shown below.</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="kt">CHARACTER</span><span class="p">(</span><span class="nb">LEN</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">PARAMETER</span><span class="p">,</span><span class="w"> </span><span class="k">PRIVATE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ModuleName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;MODULE_NAME&#39;</span>

<span class="k">CONTAINS</span>
<span class="p">...</span>

<span class="k">USE </span><span class="n">parkind1</span><span class="p">,</span><span class="w"> </span><span class="k">ONLY</span><span class="p">:</span><span class="w"> </span><span class="n">jpim</span><span class="p">,</span><span class="w"> </span><span class="n">jprb</span>
<span class="k">USE </span><span class="n">yomhook</span><span class="p">,</span><span class="w">  </span><span class="k">ONLY</span><span class="p">:</span><span class="w"> </span><span class="n">lhook</span><span class="p">,</span><span class="w"> </span><span class="n">dr_hook</span>

<span class="p">...</span>
<span class="kt">CHARACTER</span><span class="p">(</span><span class="nb">LEN</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">PARAMETER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">RoutineName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ROUTINE_NAME&#39;</span>

<span class="kt">INTEGER</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">jpim</span><span class="p">),</span><span class="w"> </span><span class="k">PARAMETER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zhook_in</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="kt">INTEGER</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">jpim</span><span class="p">),</span><span class="w"> </span><span class="k">PARAMETER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zhook_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">jprb</span><span class="p">)</span><span class="w">               </span><span class="kd">::</span><span class="w"> </span><span class="n">zhook_handle</span>

<span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">lhook</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">dr_hook</span><span class="p">(</span><span class="n">ModuleName</span><span class="o">//</span><span class="s1">&#39;:&#39;</span><span class="o">//</span><span class="n">RoutineName</span><span class="p">,</span><span class="n">zhook_in</span><span class="p">,</span><span class="n">zhook_handle</span><span class="p">)</span>

<span class="p">...</span>

<span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">lhook</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">dr_hook</span><span class="p">(</span><span class="n">ModuleName</span><span class="o">//</span><span class="s1">&#39;:&#39;</span><span class="o">//</span><span class="n">RoutineName</span><span class="p">,</span><span class="n">zhook_out</span><span class="p">,</span><span class="n">zhook_handle</span><span class="p">)</span>
</pre></div>
</div>
<p>The example subroutine shown in <a class="reference internal" href="#example"><span class="std std-ref">How to meet the coding standards</span></a> demonstrates DrHook
instrumentation.</p>
<p>Calls to DrHook add a very small overhead to the code, and so should normally
only be added to routines that do a non-trivial amount of work. Adding DrHook
calls to very small routines may represent a large increase in the workload of
those routines, and furthermore if those routines are called many thousands of
times during a single run of the UM then this will generate large amounts of
duplicate data. The developer and reviewer may decide it is unnecessary to
include DrHook calls in such routines.</p>
<p>Note that there is no benefit to adding DrHook calls to a module that consists
only of Fortran declarations and lacks any executable code.</p>
<p>DrHook calls should <em>not</em> be added to <code class="docutils literal notranslate"><span class="pre">RECURSIVE</span></code> routines as they are likely
to cause runtime errors.</p>
</section>
<section id="s15-openmp">
<span id="s15"></span><h3>S15. OpenMP<a class="headerlink" href="#s15-openmp" title="Link to this heading">#</a></h3>
<p>OpenMP is a very powerful technology for introducing shared memory parallelism
to a code, but it does have some potential for confusion. To help minimise
this, the following should be adhered to,</p>
<ul>
<li><p>Only use the OpenMP 3.1 standard. Support for OpenMP 4.0 is not yet
widespread, and implementations are somewhat immature.</p></li>
<li><p>Only use the <code class="docutils literal notranslate"><span class="pre">!$OMP</span></code> version of the directive and start at beginning of the
line (see previous general guidance on sentinels).</p></li>
<li><p>Never rely on the default behaviour for <code class="docutils literal notranslate"><span class="pre">SHARED</span></code> or <code class="docutils literal notranslate"><span class="pre">PRIVATE</span></code> variables.
The use of <code class="docutils literal notranslate"><span class="pre">DEFAULT(NONE)</span></code> is preferred, with the type of all variables
explicitly specified. A different <code class="docutils literal notranslate"><span class="pre">DEFAULT</span></code> may be allowed if the number
of variables is very large (i.e. dozens).</p></li>
<li><p>Parameters by default are shared. To make this obvious it is helpful to list
parameters used in the OMP block as a Fortran comment just before the
<code class="docutils literal notranslate"><span class="pre">PARALLEL</span></code> region.</p></li>
<li><p>Always use explicit <code class="docutils literal notranslate"><span class="pre">!$OMP</span> <span class="pre">END</span> <span class="pre">DO</span></code> - don’t rely on implicit rules.</p></li>
<li><p>Unlike <code class="docutils literal notranslate"><span class="pre">SINGLE</span></code> regions, <code class="docutils literal notranslate"><span class="pre">MASTER</span></code> regions do not carry an implicit
barrier at the end. Please add an <code class="docutils literal notranslate"><span class="pre">!$OMP</span> <span class="pre">BARRIER</span></code> directive immediately
after <code class="docutils literal notranslate"><span class="pre">!$OMP</span> <span class="pre">END</span> <span class="pre">MASTER</span></code> directives. Barriers may be omitted for
performance reasons if it is safe to do so.</p></li>
<li><p>Calls to OpenMP functions and module use should be protected by the OpenMP
sentinel. That is, the line should start with <code class="docutils literal notranslate"><span class="pre">!$</span></code> and a space. No other
comment line should start with this combination.</p></li>
<li><p>Always specify the scheduler to be used for DO loops, since the default is
implementation specific. A common default is STATIC. This is normally fine
but can cause problems within certain cases.</p></li>
<li><p>As with non-OpenMP code, you should always use the optional space to separate
the OpenMP keywords to improve readability. For example, <code class="docutils literal notranslate"><span class="pre">PARALLELDO</span></code>
should become <code class="docutils literal notranslate"><span class="pre">PARALLEL</span> <span class="pre">DO</span></code>. (See also: <a class="reference internal" href="#s4">S4</a>)</p></li>
<li><p>Any use of a sentinel (including OpenMP) should start at the beginning of the
line, e.g.</p>
<p>The following correctly uses the <code class="docutils literal notranslate"><span class="pre">!$OMP</span></code> sentinel at the beginning of the
line.</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">do_loop</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="c">!$OMP PARALLEL DO PRIVATE(i)</span>
<span class="w">      </span><span class="k">DO </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span>
<span class="w">      </span><span class="p">...</span>
<span class="w">      </span><span class="k">END DO</span>
<span class="c">!$OMP PARALLEL DO</span>
<span class="w">    </span><span class="k">END IF</span>
</pre></div>
</div>
<p>Whilst the following can lead to compilers not using the lines starting with
<code class="docutils literal notranslate"><span class="pre">!$OMP</span></code> sentinel.</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">do_loop</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">  </span><span class="c">!$OMP PARALLEL DO PRIVATE(i)</span>
<span class="w">  </span><span class="k">DO </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="k">END DO</span>
<span class="w">  </span><span class="c">!$OMP PARALLEL DO</span>
<span class="k">END IF</span>
</pre></div>
</div>
</li>
<li><p>Careful use of the OpenMP reduction clauses is required as we want to try and
preserve bit-comparison across different threads. This is not guaranteed
with some <code class="docutils literal notranslate"><span class="pre">REDUCTION</span></code> clauses.</p></li>
<li><p>OpenMP directives in C code must be protected by both a
<code class="docutils literal notranslate"><span class="pre">SHUM_USE_C_OPENMP_VIA_THREAD_UTILS</span></code> and an <code class="docutils literal notranslate"><span class="pre">_OPENMP</span></code> if-def. This
ensures it is possible to select the use of only the Fortran OpenMP runtime
library, which can prevent incompatibilities between different libraries. If
possible, provide a Fortran implementation of the OpenMP parallelism as
well, using the wrappers in the <code class="docutils literal notranslate"><span class="pre">thread_utils</span></code> module from SHUMlib.
(Further rules apply; see <a class="reference internal" href="#openmpinc"><span class="std std-ref">OpenMP in C Code</span></a> for more information.)</p></li>
</ul>
</section>
<section id="s16-mpi">
<span id="s16"></span><h3>S16. MPI<a class="headerlink" href="#s16-mpi" title="Link to this heading">#</a></h3>
<p>The Unified Model depends on the GCOM library for communications. GCOM has only
modest functionality however so the use of MPI is permitted providing the
following principles are adhered to:</p>
<ul class="simple">
<li><p>Only use MPI via GCOM’s MPL interface layer. MPI libraries can be found that
support only 32-bit argument or only 64-bit arguments. MPL is designed to
abstract this issue away.</p></li>
<li><p>Only use functionality from versions of MPI up to 3.1. These have widespread
support.</p></li>
</ul>
</section>
<section id="s17-preprocessing">
<span id="s17"></span><h3>S17. Preprocessing<a class="headerlink" href="#s17-preprocessing" title="Link to this heading">#</a></h3>
<p>Use of preprocessor directives should only be used when its inclusion can be
justified, e.g. machine dependent options or reducing duplication of a large
code section, see <a class="reference internal" href="#s18">S18</a>.</p>
<p>Do not use preprocessing directives (<code class="docutils literal notranslate"><span class="pre">#if</span></code>, <code class="docutils literal notranslate"><span class="pre">#include</span></code>, <code class="docutils literal notranslate"><span class="pre">#endif</span></code>) for
selecting science code section versions. Do not use <code class="docutils literal notranslate"><span class="pre">#include</span></code> directive to
pass a large list of arrays or to pass common items.</p>
<p>In particular:</p>
<ul>
<li><dl class="simple">
<dt>“Must” use <code class="docutils literal notranslate"><span class="pre">#if</span> <span class="pre">defined</span></code> rather than <code class="docutils literal notranslate"><span class="pre">#if</span></code>. If the CPP flag does not</dt><dd><p>exist the pre-processor evaluates the test to true.</p>
</dd>
</dl>
</li>
<li><p>Use run-time rather than compile time switches</p></li>
<li><p>Do not replicate run-time switches with compile-time ones, so avoid</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="cp">#if defined(OCEAN)</span>
<span class="w">  </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">submodel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ocean</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="cp">#endif</span>
<span class="p">...</span>
<span class="cp">#if defined(OCEAN)</span>
<span class="w">  </span><span class="k">END IF</span>
<span class="cp">#endif</span>
</pre></div>
</div>
</li>
<li><p>Do not add optional arguments to subroutines protected by directives, instead
migrate to FORTRAN 95/2003 code and make use of OPTIONAL argument
functionality.</p></li>
<li><p>Put <code class="docutils literal notranslate"><span class="pre">#if</span></code> lines inside included files rather than around the <code class="docutils literal notranslate"><span class="pre">#include</span></code>
itself.</p></li>
<li><p>Use directive names that clearly indicate their purpose.</p></li>
<li><p>When removing scientific sections, remove variables that were only needed for
that section.</p></li>
<li><p>Do not wrap a routine within CPP flags. Let the compiler work out when it is
required.</p></li>
<li><p>Please refrain from using consecutive question marks (<code class="docutils literal notranslate"><span class="pre">??</span></code>) in the source
code as some preprocessors can interpret them as C trigraphs.</p></li>
</ul>
</section>
<section id="s18-code-duplication">
<span id="s18"></span><h3>S18. Code duplication<a class="headerlink" href="#s18-code-duplication" title="Link to this heading">#</a></h3>
<p>In the case of a large area of code that needs to be duplicated, e.g. same
computation applied to different types, then the use of the <code class="docutils literal notranslate"><span class="pre">#include</span></code>
preprocessing directive is recommended by adhering the following rules:</p>
<ul class="simple">
<li><p>Only one include file per routine. If a routine needs multiple include files,
consider dividing the routine into small multiple routines. The same include
file cannot be used in multiple modules or routines. Consider creating a
special routine with the shared code if needed.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">*.h</span></code> as a file extension for <code class="docutils literal notranslate"><span class="pre">#include</span></code> files since the build system
will automatically recognise it.</p></li>
<li><p>File name should always be <code class="docutils literal notranslate"><span class="pre">modulename_routinename.h</span></code>. An accepted
exception is when the module name and the routine name are the same, e.g.
instead of <code class="docutils literal notranslate"><span class="pre">routine_mod_routine.h</span></code> use <code class="docutils literal notranslate"><span class="pre">routine.h</span></code>.</p></li>
<li><p>The include file should be located in a special <code class="docutils literal notranslate"><span class="pre">include</span></code> sub-directory
where the Fortran module is located.</p></li>
<li><p>An include file should only be used for reducing code duplication, not for
performance reason. Let the compiler implement proper in-lining.</p></li>
</ul>
<p>The following code shows an example on how to use the <code class="docutils literal notranslate"><span class="pre">#include</span></code>
preprocessing directive inside a module to reduce code duplication.</p>
<ul>
<li><p>The module file <code class="docutils literal notranslate"><span class="pre">my_mod.F90</span></code> in the <code class="docutils literal notranslate"><span class="pre">src/path/to/mod</span></code> directory with the
duplicated routines:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">INTERFACE </span><span class="n">calc_1</span>
<span class="w">    </span><span class="k">MODULE PROCEDURE </span><span class="n">calc_1_32bit</span><span class="p">,</span><span class="n">calc_1_64bit</span>
<span class="k">END INTERFACE</span>

<span class="k">SUBROUTINE </span><span class="n">calc_1_32bit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
<span class="k">IMPLICIT NONE</span>
<span class="kt">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="k">PARAMETER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">prec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">real32</span>

<span class="cp">#include &quot;my_mod_calc_1.h&quot;</span>

<span class="k">END SUBROUTINE</span>

<span class="k">SUBROUTINE </span><span class="n">calc_1_64bit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
<span class="k">IMPLICIT NONE</span>
<span class="kt">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="k">PARAMETER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">prec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">real64</span>

<span class="cp">#include &quot;my_mod_calc_1.h&quot;</span>

<span class="k">END SUBROUTINE</span>
</pre></div>
</div>
</li>
<li><p>The included file <code class="docutils literal notranslate"><span class="pre">my_mod_calc_1.h</span></code> in the <code class="docutils literal notranslate"><span class="pre">src/path/to/mod/include</span></code>
directory with the shared code:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">! --- Begin shared body of calc_1 ---</span>
<span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">prec</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">r</span>
<span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">prec</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span>
<span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">prec</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">d</span>

<span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">d</span>
<span class="c">! --- End shared body of calc_1 ---</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="s19-error-reporting">
<span id="s19"></span><h3>S19. Error reporting<a class="headerlink" href="#s19-error-reporting" title="Link to this heading">#</a></h3>
<p>The most important rule in error reporting is <em>never</em> to <code class="docutils literal notranslate"><span class="pre">CALL</span> <span class="pre">abort</span></code> or to
use <code class="docutils literal notranslate"><span class="pre">STOP</span></code>; these can cause problems in a parallel computing environment.
Where it is possible that errors may occur they should be detected and
appropriate action taken. Errors may be of two types: fatal errors requiring
program termination; and non-fatal warnings which allow the program to
continue. Both types are passed to a reporting routine <code class="docutils literal notranslate"><span class="pre">ereport</span></code>, which
takes different actions depending on the value of the error code passed to it
as an argument:</p>
<ul class="simple">
<li><p>If the error code is <code class="docutils literal notranslate"><span class="pre">&gt;</span> <span class="pre">0</span></code> an error message will be printed and the
program will abort (hopefully with a traceback).</p></li>
<li><p>If the error code is <code class="docutils literal notranslate"><span class="pre">&lt;</span> <span class="pre">0</span></code> a warning message will be printed, the error
code variable will be reset to 0, and the program continues.</p></li>
<li><p>If the error code is 0 nothing happens and the program continues
uninterrupted.</p></li>
</ul>
<p>Both warnings and errors are sent to the <code class="docutils literal notranslate"><span class="pre">.pe</span></code><span class="math notranslate nohighlight">\(n\)</span> file <em>of the
processor generating the warning</em>, which is stdout for processor 0 only.
Warnings will only appear in stderr if they occur on processor 0. Errors will
always appear in stderr. Note that if a warning occurs on a processor for
which output has been disabled using the print manager settings, then that
warning will not be printed as there will be no <code class="docutils literal notranslate"><span class="pre">.pe</span></code><span class="math notranslate nohighlight">\(n\)</span> file to
send it to.</p>
<p>When using <code class="docutils literal notranslate"><span class="pre">READ</span></code> or <code class="docutils literal notranslate"><span class="pre">OPEN</span></code> or other Fortran intrinsics which deal with IO,
please use both the error status <code class="docutils literal notranslate"><span class="pre">IOSTAT</span></code> and the error message <code class="docutils literal notranslate"><span class="pre">IOMSG</span></code>
arguments, followed by code printing the latter if the former is non-zero. The
<code class="docutils literal notranslate"><span class="pre">check_iostat</span></code> subroutine provides a convenient way to do this; any non-zero
value of <code class="docutils literal notranslate"><span class="pre">IOSTAT</span></code> will cause it to print the return value of <code class="docutils literal notranslate"><span class="pre">IOMSG</span></code> and
abort the program.</p>
<ul>
<li><p>The arguments of <code class="docutils literal notranslate"><span class="pre">ereport</span></code> are:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">SUBROUTINE </span><span class="n">ereport</span><span class="w"> </span><span class="p">(</span><span class="n">RoutineName</span><span class="p">,</span><span class="w"> </span><span class="n">ErrorStatus</span><span class="p">,</span><span class="n">Message</span><span class="p">)</span>

<span class="kt">CHARACTER</span><span class="p">(</span><span class="nb">LEN</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w">     </span><span class="kd">::</span><span class="w"> </span><span class="n">RoutineName</span><span class="w">   </span><span class="c">! Name of the calling routine</span>
<span class="kt">CHARACTER</span><span class="p">(</span><span class="nb">LEN</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w">     </span><span class="kd">::</span><span class="w"> </span><span class="n">Message</span><span class="w">       </span><span class="c">! Error message for output</span>
<span class="kt">INTEGER</span><span class="p">,</span><span class="w">          </span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="w"> </span><span class="n">OUT</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ErrorStatus</span><span class="w">   </span><span class="c">! Error code</span>
</pre></div>
</div>
</li>
<li><p>Ensure the error code variable is set to zero before use. This includes at
the start of every routine where it is a local variable, and also before
calling any routine that returns it(<code class="docutils literal notranslate"><span class="pre">INTENT(IN</span> <span class="pre">OUT)</span></code>).</p></li>
<li><p>Error messages should contain enough information to <em>help</em> the user diagnose
and solve the problem.</p></li>
<li><p>Avoid splitting error information between stdout (<code class="docutils literal notranslate"><span class="pre">umprint</span></code>) and stderr
(<code class="docutils literal notranslate"><span class="pre">ereport</span></code>). Keep the details in one place where possible. If the nature
of the error requires large quantities of additional data in stdout to
diagnose it properly, make this clear in the error message.</p></li>
<li><p>The variable <code class="docutils literal notranslate"><span class="pre">errormessagelength</span></code> in module <code class="docutils literal notranslate"><span class="pre">errormessagelength_mod</span></code> is
provided for declaring the length of <code class="docutils literal notranslate"><span class="pre">CHARACTER</span></code> variables to be used with
error reporting. This provides a longer string for holding e.g. the return
value of an <code class="docutils literal notranslate"><span class="pre">IMOSG</span></code> argument.</p></li>
<li><p>Avoid using a namelist input value or the return code of another routine as
the error code, especially if you do not know what values it may take. It
may not be apparent to the user that the problem value is actually the error
code, or what sign it originally had. Use a dedicated error code and include
the return code or problematic value in the message itself.</p>
<p>Common practice:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">foo</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">  </span><span class="n">icode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">ABS</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
<span class="w">  </span><span class="n">cmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Invalid input value for foo&#39;</span>
<span class="w">  </span><span class="k">CALL </span><span class="n">ereport</span><span class="p">(</span><span class="n">RoutineName</span><span class="p">,</span><span class="w"> </span><span class="n">icode</span><span class="p">,</span><span class="w"> </span><span class="n">cmessage</span><span class="p">)</span>
<span class="k">END IF</span>
</pre></div>
</div>
<p>Better approach:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">foo</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">  </span><span class="n">icode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span>
<span class="w">  </span><span class="k">WRITE</span><span class="p">(</span><span class="n">cmessage</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(A,I0)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Invalid input value for foo. Value received: &#39;</span><span class="p">,</span><span class="n">foo</span>
<span class="w">  </span><span class="k">CALL </span><span class="n">ereport</span><span class="p">(</span><span class="n">RoutineName</span><span class="p">,</span><span class="w"> </span><span class="n">icode</span><span class="p">,</span><span class="w"> </span><span class="n">cmessage</span><span class="p">)</span>
<span class="k">END IF</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="specific-standards">
<span id="sec-specific"></span><h2>Specific standards<a class="headerlink" href="#specific-standards" title="Link to this heading">#</a></h2>
<section id="runtime-namelist-variables-defaults-future-development">
<span id="namelists"></span><h3>Runtime namelist variables, defaults, future development<a class="headerlink" href="#runtime-namelist-variables-defaults-future-development" title="Link to this heading">#</a></h3>
<p>The UM reads in a number of run time ‘control’ namelists; within READLSTA.F90.
Examples are the <code class="docutils literal notranslate"><span class="pre">RUN_&lt;physics&gt;</span></code> type namelists. When new science options
are required to be added to the UM the developer is expected to add the new
variable/parameter to the relevant <code class="docutils literal notranslate"><span class="pre">RUN_&lt;physics&gt;</span></code> namelist and declaration
in the corresponding module, updating READLSTA.F90 as required.</p>
<p>The use of <code class="docutils literal notranslate"><span class="pre">cruntimc.h</span></code> is to be avoided as this approach is being phased out
in favour of suitable modules.</p>
<ul>
<li><p>Code development should use MODULES to define namelist LOGICALS, PARAMETERS
and VARIABLES (and their defaults) alongwith the NAMELIST.</p></li>
<li><p>It is essential that defaults are set; items within namelists are expected to
fall into 3 camps:</p>
<ul>
<li><p>variable never actually changes; it is a default for all users</p>
<ul class="simple">
<li><p>this should be set in the code and removed from any input namelist.</p></li>
</ul>
</li>
<li><p>variable rarely changes;</p>
<ul class="simple">
<li><p>set identified default within UM code, with comment explaining choice.</p></li>
<li><p>We advise that these are not included in the namelist. A code change will
be required to alter it.</p></li>
</ul>
</li>
<li><p>regularly changes or is a new item and thus no default is yet suitable</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">LOGICAL</span></code>s usually to <code class="docutils literal notranslate"><span class="pre">FALSE</span></code></p></li>
<li><p>variables set to RMDI or IMDI</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CHARACTER</span></code> strings should be set to a default string. For
example,</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="n">aero_data_dir</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;aero data dir is unset&#39;</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>An example of preferred practice see <code class="docutils literal notranslate"><span class="pre">RUN_Stochastic</span></code>. The namelist variables
are all defined within a MODULE, <code class="docutils literal notranslate"><span class="pre">stochastic_physics_run_mod.F90</span></code>, including
default values.</p>
</section>
<section id="defensive-input-programming">
<h3>Defensive input programming<a class="headerlink" href="#defensive-input-programming" title="Link to this heading">#</a></h3>
<p>When real or integer values are read into the code by a namelist, the Rose
metadata should either use a values list or a range so that the Rose GUI can
warn the user of invalid values. These values should also be tested in the
code to ensure that the values read in are valid. As it is possible to edit
Rose namelists, or ignore Rose GUI warnings, the GUI should not be relied on
for checking that input values of reals and integers are valid. It may also be
appropriate to check logical values if a specific combination of logicals will
cause an error for example.</p>
<p>The routine, <code class="docutils literal notranslate"><span class="pre">chk_var</span></code>, is available for developers to more easily check
their inputs. Checks made by <code class="docutils literal notranslate"><span class="pre">chk_var</span></code> should match any checks made by Rose,
however checks by <code class="docutils literal notranslate"><span class="pre">chk_var</span></code> are made by the code and will by default, abort
the run. Developers should refer to the <a class="reference external" href="https://metoffice.github.io/um_doc/um-training/index.html">um-training</a> for
more information on <code class="docutils literal notranslate"><span class="pre">chk_var</span></code>.</p>
</section>
<section id="optimised-namelist-reading-procedures">
<h3>Optimised namelist reading procedures<a class="headerlink" href="#optimised-namelist-reading-procedures" title="Link to this heading">#</a></h3>
<p>As of UM9.1 the procedure to read UM namelists has been enhanced but this has
implications for the code developer, requiring extra code changes when
adding/removing a UM input namelist item. Tied with each namelist read is now
the requirement for a ‘read_nml_routine’ usually found in the containing
module of the namelist.</p>
<p>If a coder wishes to add a new variable to a namelist (xxxxxx) then the new
read_nml_xxxxxx subroutine will need changing. The changes required are:</p>
<ul class="simple">
<li><p>increment the relevant type parameter by the variable size (for a real scalar
increase n_real by 1)</p></li>
<li><p>add a new line to the list in the my_namelist type declaration in the
relevant variable type.</p></li>
<li><p>add a new line to the my_nml population section in the relevant variable
type</p></li>
<li><p>add a new line to the namelist population section in the relevant variable
type.</p></li>
</ul>
<p>See the UM code for examples.</p>
</section>
<section id="unix-script-standards">
<h3>Unix script standards<a class="headerlink" href="#unix-script-standards" title="Link to this heading">#</a></h3>
<p>This standard covers UM shell scripts which are used in the operational suite
as well as within the UM itself. The requirements that this standard is
intended to meet are as follows:</p>
<ul class="simple">
<li><p>The script should be easily understood and used, and should be easy for a
programmer other than the original author to modify.</p></li>
<li><p>To simplify portability it should conform to the unix standard as much as
possible, and exclude obsolescent and implementation-specific features when
possible.</p></li>
<li><p>It should be written in an efficient way.</p></li>
<li><p>The structure of the script should conform to the design agreed in the
project plan.</p></li>
</ul>
<p>Scripts are to be regarded as being control code as far as external
documentation is concerned.</p>
</section>
<section id="python-standards">
<h3>Python standards<a class="headerlink" href="#python-standards" title="Link to this heading">#</a></h3>
<p>Python code used in or with the UM should obey the standard Python style guide
<a class="reference external" href="http://www.python.org/dev/peps/pep-0008/">PEP 8</a>. This means that our
Python code will follow the same guidelines commonly adhered to in other
Python projects, including Rose.</p>
</section>
<section id="c-standards">
<h3>C standards<a class="headerlink" href="#c-standards" title="Link to this heading">#</a></h3>
<p>C code used in or with the UM should conform to the C99 standard
(<a class="reference external" href="http://www.iso.org/iso/iso_catalogue/catalogue_ics/catalogue_detail_ics.htm?csnumber=29237">ISO/IEC 9899:1999: Programming languages - C (1999) by JTC 1/SC 22/WG 14</a>).</p>
<p>Furthermore, it is assumed that any C implementation used by the UM supports
C99 Annex F (IEC 60559 Floating-point arithmetic) i.e. it is assumed the
implementation defines <code class="docutils literal notranslate"><span class="pre">__STDC_IEC_559__</span></code>. It is also assumed the
implementation provides the optional 8-, 16-, 32-, and 64-bit exact-width
integer types.</p>
<section id="preprocessing-of-c">
<h4>Preprocessing of C<a class="headerlink" href="#preprocessing-of-c" title="Link to this heading">#</a></h4>
<p>Preprocessing of source files is allowed, as defined by the C99 standard, but
with a few minor exceptions. This use includes - but is not limited to - the
use of <code class="docutils literal notranslate"><span class="pre">#include</span></code>, macros, <code class="docutils literal notranslate"><span class="pre">#pragma</span></code>, and <code class="docutils literal notranslate"><span class="pre">_Pragma</span></code> statements.</p>
<p>The exceptions are as follows:</p>
<ul class="simple">
<li><p>Code must not be dependent on preprocessing to select optional or platform
specific features in order for it to compile or run. Platform specific and
optional code are allowed; but this should augment basic functionality
rather than implment a key component of it. In other words, code should be
able to compile and run correctly on all platforms without any optional or
platform dependent macros being defined, even if the code could take
advantage of them on that platform.</p></li>
<li><p>Platform specific code must be protected by an if-def test on a compiler
and/or platform specific macro as appropriate. (Examples may include the use
of <code class="docutils literal notranslate"><span class="pre">__GNUC__</span></code>, <code class="docutils literal notranslate"><span class="pre">__clang__</span></code>, <code class="docutils literal notranslate"><span class="pre">__linux__</span></code>, <code class="docutils literal notranslate"><span class="pre">_AIX</span></code>, <code class="docutils literal notranslate"><span class="pre">__x86_64__</span></code>, or
<code class="docutils literal notranslate"><span class="pre">__aarch64__</span></code>) This includes the protection of compiler-specific
<code class="docutils literal notranslate"><span class="pre">#pragma</span></code>/<code class="docutils literal notranslate"><span class="pre">_Pragma</span></code> statements.</p></li>
<li><p>If-def tests must not use the <code class="docutils literal notranslate"><span class="pre">#ifdef</span></code>/<code class="docutils literal notranslate"><span class="pre">#ifndef</span></code> style. Instead use <code class="docutils literal notranslate"><span class="pre">#if</span>
<span class="pre">defined()</span></code> or <code class="docutils literal notranslate"><span class="pre">#if</span> <span class="pre">!defined()</span></code> as appropriate. This restriction is
required to simplify the implementation of automated testing.</p></li>
</ul>
</section>
<section id="code-layout">
<h4>Code Layout<a class="headerlink" href="#code-layout" title="Link to this heading">#</a></h4>
<p>Rules regarding whitespace, 80 column line widths, prohibition on tab use, and
the use of UK English apply to C code as they would Fortran code. Comments
should use the traditional <code class="docutils literal notranslate"><span class="pre">/*</span> <span class="pre">*/</span></code> style; C++ style comments (<code class="docutils literal notranslate"><span class="pre">//</span></code>) should
be avoided.</p>
</section>
<section id="copyright-and-code-owner-comments">
<h4>Copyright and Code Owner Comments<a class="headerlink" href="#copyright-and-code-owner-comments" title="Link to this heading">#</a></h4>
<p>Copyright and code owner comments follow the same rules as in Fortran, except
with slight modification for the differing comment delimiters in the two
languages — using <code class="docutils literal notranslate"><span class="pre">/*</span> <span class="pre">*/</span></code> instead of <code class="docutils literal notranslate"><span class="pre">!</span></code>. An example of a compliant
comment header detailing copyright and code owner comments is given below.</p>
<div class="minipage docutils container">
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cm">/**********************************COPYRIGHT***********************************/</span>
<span class="cm">/*            (C) Crown copyright Met Office. All rights reserved.            */</span>
<span class="cm">/*         For further details please refer to the file COPYRIGHT.txt         */</span>
<span class="cm">/*        which you should have received as part of this distribution.        */</span>
<span class="cm">/**********************************COPYRIGHT***********************************/</span>

<span class="cm">/* Code Owner: Please refer to the UM file CodeOwners.txt                     */</span>
<span class="cm">/* This file belongs in section: C Code                                       */</span>
</pre></div>
</div>
</div>
</section>
<section id="deprecated-identifiers">
<h4>Deprecated identifiers<a class="headerlink" href="#deprecated-identifiers" title="Link to this heading">#</a></h4>
<p>In addition to the identifiers deprecated by the C99 standard, the following
table lists identifiers which should be considered deprecated within UM code —
and where appropriate, what to replace them with.</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Deprecated indentifier</strong></p></th>
<th class="head"><p><strong>Replace with</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">sprintf()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">snprintf()</span></code> <a class="footnote-reference brackets" href="#f1" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">strcpy()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">strncpy()</span></code> <a class="footnote-reference brackets" href="#f1" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></p></td>
</tr>
</tbody>
</table>
</div>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="f1" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id1">1</a>,<a role="doc-backlink" href="#id2">2</a>)</span>
<p>These functions take different arguments from the original deprecated functions they replace.</p>
</aside>
</aside>
</section>
<section id="openmp-in-c-code">
<span id="openmpinc"></span><h4>OpenMP in C Code<a class="headerlink" href="#openmp-in-c-code" title="Link to this heading">#</a></h4>
<p>It is possible for the runtime libraries used by OpenMP to be incompatible if
different vendors or compiler versions are used for the C and Fortran
compiler. For this reason, whilst use of OpenMP in C code is permitted, there
are some rules governing acceptable use that must be followed.</p>
</section>
<section id="protecting-openmp-in-c-code">
<h4>Protecting OpenMP in C Code<a class="headerlink" href="#protecting-openmp-in-c-code" title="Link to this heading">#</a></h4>
<p>OpenMP directives (<code class="docutils literal notranslate"><span class="pre">#pragma</span> <span class="pre">omp</span></code>) in C code must be protected by both a
<code class="docutils literal notranslate"><span class="pre">SHUM_USE_C_OPENMP_VIA_THREAD_UTILS</span></code> and an <code class="docutils literal notranslate"><span class="pre">_OPENMP</span></code> <code class="docutils literal notranslate"><span class="pre">#ifdef</span></code>. This
ensures it is possible to select the use of only the Fortan OpenMP runtime
library if required. If possible, provide a Fortran implementation of the
OpenMP parallelism as well, using the wrappers in the <code class="docutils literal notranslate"><span class="pre">thread_utils</span></code> module
from SHUMlib. An example of such use is given below.</p>
<div class="minipage docutils container">
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#if defined(_OPENMP) &amp;&amp; defined(SHUM_USE_C_OPENMP_VIA_THREAD_UTILS)</span>

<span class="w"> </span><span class="cm">/* this branch uses the Fortran OpenMP runtime, via the SHUMlib thread_utils module */</span>
<span class="w"> </span><span class="n">thread_utils_func</span><span class="p">();</span>

<span class="cp">#elif defined(_OPENMP) &amp;&amp; !defined(SHUM_USE_C_OPENMP_VIA_THREAD_UTILS)</span>

<span class="w"> </span><span class="cm">/* this branch uses OpenMP pragmas within C */</span>
<span class="w"> </span><span class="cp">#pragma omp parallel</span>
<span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">omp_func</span><span class="p">();</span>
<span class="w"> </span><span class="p">}</span>

<span class="cp">#else</span>

<span class="w"> </span><span class="cm">/* this branch does not use OpenMP */</span>
<span class="w"> </span><span class="n">serial_func</span><span class="p">();</span>

<span class="cp">#endif</span>
</pre></div>
</div>
</div>
<p>Ideally this should lead to code capable of providing all three possible
runtime outcomes, the use of which are compile-time configurable:</p>
<ul class="simple">
<li><p>No OpenMP is used.</p></li>
<li><p>OpenMP is used through the C runtime library. (The compiler defines
<code class="docutils literal notranslate"><span class="pre">_OPENMP</span></code>, through the nomal compiler switch selection process.)</p></li>
<li><p>OpenMP is used through the Fortran runtime library, accesed via SHUMlib.
(The compiler defines <code class="docutils literal notranslate"><span class="pre">_OPENMP</span></code>; the user defines
<code class="docutils literal notranslate"><span class="pre">SHUM_USE_C_OPENMP_VIA_THREAD_UTILS</span></code>)</p></li>
</ul>
<p>You must always ensure that the no OpenMP case is possible.</p>
<p>(See also: The SHUMlib documentation on <code class="docutils literal notranslate"><span class="pre">shum_thread_utils</span></code>)</p>
</section>
<section id="other-uses-of-the-openmp-macro">
<h4>Other Uses of the _OPENMP Macro<a class="headerlink" href="#other-uses-of-the-openmp-macro" title="Link to this heading">#</a></h4>
<p>The use of the <code class="docutils literal notranslate"><span class="pre">_OPENMP</span></code> preprocessor macro for code other than directives is
permitted. This can be used equivalently to how the <code class="docutils literal notranslate"><span class="pre">!$</span></code> sentinel would be
in Fortran. A recommended use is to protect the inclusion of the header for
the <code class="docutils literal notranslate"><span class="pre">thread_utils</span></code> module, as shown below.</p>
<div class="minipage docutils container">
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#if defined(_OPENMP) &amp;&amp; defined(SHUM_USE_C_OPENMP_VIA_THREAD_UTILS)</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;c_shum_thread_utils.h&quot;</span>
<span class="cp">#endif</span>
</pre></div>
</div>
</div>
<p>Or to protect inclusion of the OpenMP header, as shown below.</p>
<div class="minipage docutils container">
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#if defined(_OPENMP) &amp;&amp; !defined(SHUM_USE_C_OPENMP_VIA_THREAD_UTILS)</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span>
<span class="cp">#endif</span>
</pre></div>
</div>
</div>
</section>
<section id="further-rules-for-openmp-in-c">
<h4>Further Rules for OpenMP in C<a class="headerlink" href="#further-rules-for-openmp-in-c" title="Link to this heading">#</a></h4>
<p>In order to standardise the way the above rules are implemented, and to allow
for automated checking of the compliance of code, the following additional
rules are imposed.</p>
<ul>
<li><p>You cannot hide the use of the <code class="docutils literal notranslate"><span class="pre">_OPENMP</span></code> &amp;
<code class="docutils literal notranslate"><span class="pre">SHUM_USE_C_OPENMP_VIA_THREAD_UTILS</span></code> macros through the definition of a
third macro dependent on them. For example, you must not define and use a
new macro in place of the two original macros, as shown here:</p>
<div class="minipage docutils container">
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define USE_THREAD_UTILS defined(_OPENMP) &amp;&amp; defined(SHUM_USE_C_OPENMP_VIA_THREAD_UTILS)</span>

<span class="cp">#if defined(USE_THREAD_UTILS)</span>
<span class="w">  </span><span class="n">thread_utils_func</span><span class="p">();</span>
<span class="cp">#endif</span>
</pre></div>
</div>
</div>
</li>
<li><p>If-def tests on <code class="docutils literal notranslate"><span class="pre">_OPENMP</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">SHUM_USE_C_OPENMP_VIA_THREAD_UTILS</span></code> must
always occur as a pair. You may not test the use of <code class="docutils literal notranslate"><span class="pre">_OPENMP</span></code> or
<code class="docutils literal notranslate"><span class="pre">SHUM_USE_C_OPENMP_VIA_THREAD_UTILS</span></code> in isolation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_OPENMP</span></code> must come first in any <code class="docutils literal notranslate"><span class="pre">#if</span> <span class="pre">defined()</span></code> pair.</p></li>
<li><p>Any OpenMP <code class="docutils literal notranslate"><span class="pre">#if</span> <span class="pre">defined()</span></code> pair must not also include a logical test on a
third macro. If this functionality is required, find an appropriate nesting
of <code class="docutils literal notranslate"><span class="pre">#if</span> <span class="pre">defined()</span></code> tests. For example instead of:</p>
<div class="minipage docutils container">
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#if defined(_OPENMP) &amp;&amp; defined(SHUM_USE_C_OPENMP_VIA_THREAD_UTILS) &amp;&amp; defined(OTHER)</span>
<span class="cm">/* do stuff */</span>
<span class="cp">#endif</span>
</pre></div>
</div>
</div>
<p>Use:</p>
<div class="minipage docutils container">
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#if defined(_OPENMP) &amp;&amp; defined(SHUM_USE_C_OPENMP_VIA_THREAD_UTILS)</span>
<span class="cp">#if defined(OTHER)</span>
<span class="w"> </span><span class="cm">/* do stuff */</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
</pre></div>
</div>
</div>
</li>
<li><p>You must not use negative logic in an if-def test on <code class="docutils literal notranslate"><span class="pre">_OPENMP</span></code>
(i.e. <code class="docutils literal notranslate"><span class="pre">#if</span> <span class="pre">!defined(_OPENMP)</span></code>). Instead, use positive logic and an
<code class="docutils literal notranslate"><span class="pre">#else</span></code> branch. Use of negative logic is permitted for if-def tests on the
accompanying <code class="docutils literal notranslate"><span class="pre">SHUM_USE_C_OPENMP_VIA_THREAD_UTILS</span></code> macro, as this will be
required to distinguish between cases using the C and Fortan OpenMP
runtimes.</p></li>
</ul>
</section>
</section>
</section>
<section id="code-reviews">
<span id="sec-reviews"></span><h2>Code Reviews<a class="headerlink" href="#code-reviews" title="Link to this heading">#</a></h2>
<p>In order to ensure that these standards are adhered to and are having the
desired effect code reviews must be held. Reviews can also be useful in
disseminating computing skills. To this end two types of code review are
performed in the order below:</p>
<ol class="arabic simple">
<li><p>A science/technical review is performed first to ensure that the code
performs as it is intended, it complies with the standards and is well
documented. Guidance for reviewers is found in the <a class="reference external" href="https://metoffice.github.io/simulation-systems/Reviewers/scitechreview.html">Science/Technical
Review Guidance</a>
page on the UM homepage.</p></li>
<li><p>A Code Review is performed to analyse the change for its impact,
ensure that it meets this coding standard and to ensure that all concerned
parties are made aware of changes that are required. Guidance for reviewers
is outlined in <a class="reference external" href="https://metoffice.github.io/simulation-systems/Reviewers/codereview.html">Code Review Guidance page</a>.</p></li>
</ol>
</section>
<section id="a-um-software-standard-summary">
<span id="appendix-a"></span><h2>A. UM Software standard summary<a class="headerlink" href="#a-um-software-standard-summary" title="Link to this heading">#</a></h2>
<p>The rules discussed in the main text are reproduced here in summary form with
pdf links to the sections.</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Standard</strong></p></th>
<th class="head"><p><strong>Section</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Use the naming convention for
program units.</p></td>
<td><p><a class="reference internal" href="#s1">S1</a></p></td>
</tr>
<tr class="row-odd"><td><p>Use your header and supply the
appropriately complete code
header</p></td>
<td><p><a class="reference internal" href="#s2">S2</a></p></td>
</tr>
<tr class="row-even"><td><p>History comments are NOT
required and should be removed
from routines.</p></td>
<td><p><a class="reference internal" href="#s2">S2</a></p></td>
</tr>
<tr class="row-odd"><td><p>Fortan code should be written in
free source form</p></td>
<td><p><a class="reference internal" href="#s3">S3</a></p></td>
</tr>
<tr class="row-even"><td><p>Code must occur in columns 1-80
(1-100 for CreateBC).</p></td>
<td><p><a class="reference internal" href="#s3">S3</a></p></td>
</tr>
<tr class="row-odd"><td><p>Never put more than one
statement per line.</p></td>
<td><p><a class="reference internal" href="#s3">S3</a></p></td>
</tr>
<tr class="row-even"><td><p>Use English in your code.</p></td>
<td><p><a class="reference internal" href="#s3">S3</a></p></td>
</tr>
<tr class="row-odd"><td><p>All Fortran keywords should be
ALL CAPS while everything else
is lowercase or CamelCase.</p></td>
<td><p><a class="reference internal" href="#s4">S4</a></p></td>
</tr>
<tr class="row-even"><td><p>Avoid archaic Fortran features</p></td>
<td><p><a class="reference internal" href="#s4">S4</a></p></td>
</tr>
<tr class="row-odd"><td><p>Only use the generic names of
intrinsic functions</p></td>
<td><p><a class="reference internal" href="#s4">S4</a></p></td>
</tr>
<tr class="row-even"><td><p>Comments start with a single
<code class="docutils literal notranslate"><span class="pre">!</span></code> at beginning of line.</p></td>
<td><p><a class="reference internal" href="#s5">S5</a></p></td>
</tr>
<tr class="row-odd"><td><p>Single line comments can be
indented within the code, after
the statement.</p></td>
<td><p><a class="reference internal" href="#s5">S5</a></p></td>
</tr>
<tr class="row-even"><td><p>Do not leave a blank line after
a comment line.</p></td>
<td><p><a class="reference internal" href="#s5">S5</a></p></td>
</tr>
<tr class="row-odd"><td><p>Do NOT use TABS within UM code.</p></td>
<td><p><a class="reference internal" href="#s5">S5</a></p></td>
</tr>
<tr class="row-even"><td><p>The use of MODULEs is greatly
encouraged.</p></td>
<td><p><a class="reference internal" href="#s6">S6</a></p></td>
</tr>
<tr class="row-odd"><td><p>Use meaningful variable names</p></td>
<td><p><a class="reference internal" href="#s7">S7</a></p></td>
</tr>
<tr class="row-even"><td><p>Use and declare variables and
arguments in the order</p></td>
<td><p><a class="reference internal" href="#s7">S7</a></p></td>
</tr>
<tr class="row-odd"><td><p>Use <code class="docutils literal notranslate"><span class="pre">INTENT</span></code> in declaring
arguments</p></td>
<td><p><a class="reference internal" href="#s7">S7</a></p></td>
</tr>
<tr class="row-even"><td><p>Use <code class="docutils literal notranslate"><span class="pre">IMPLICIT</span> <span class="pre">NONE</span></code>.</p></td>
<td><p><a class="reference internal" href="#s7">S7</a></p></td>
</tr>
<tr class="row-odd"><td><p>Use <code class="docutils literal notranslate"><span class="pre">REAL,</span> <span class="pre">EXTERNAL</span> <span class="pre">::</span> <span class="pre">func1</span></code>
for functions</p></td>
<td><p><a class="reference internal" href="#s7">S7</a></p></td>
</tr>
<tr class="row-even"><td><p>Do not use <code class="docutils literal notranslate"><span class="pre">EXTERNAL</span></code>
statements for subroutines</p></td>
<td><p><a class="reference internal" href="#s7">S7</a></p></td>
</tr>
<tr class="row-odd"><td><p>The use of ALLOCATABLE arrays
can optmize memory use.</p></td>
<td><p><a class="reference internal" href="#s8">S8</a></p></td>
</tr>
<tr class="row-even"><td><p>Indent code within <code class="docutils literal notranslate"><span class="pre">DO</span></code> or
<code class="docutils literal notranslate"><span class="pre">IF</span></code> blocks by 2 characters</p></td>
<td><p><a class="reference internal" href="#s9">S9</a></p></td>
</tr>
<tr class="row-odd"><td><p>Terminate loops with <code class="docutils literal notranslate"><span class="pre">END</span> <span class="pre">DO</span></code></p></td>
<td><p><a class="reference internal" href="#s9">S9</a></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">EXIT</span></code> statements must be
labelled</p></td>
<td><p><a class="reference internal" href="#s9">S9</a></p></td>
</tr>
<tr class="row-odd"><td><p>Avoid comparing two reals
<code class="docutils literal notranslate"><span class="pre">IF</span> <span class="pre">(</span> <span class="pre">real1</span> <span class="pre">==</span> <span class="pre">real2</span> <span class="pre">)</span> <span class="pre">THEN</span></code></p></td>
<td><p><a class="reference internal" href="#s9">S9</a></p></td>
</tr>
<tr class="row-even"><td><p>Avoid using ‘magic numbers’ and
‘magic logicals’</p></td>
<td><p><a class="reference internal" href="#s9">S9</a></p></td>
</tr>
<tr class="row-odd"><td><p>Avoid use of <code class="docutils literal notranslate"><span class="pre">GO</span> <span class="pre">TO</span></code></p></td>
<td><p><a class="reference internal" href="#s9">S9</a></p></td>
</tr>
<tr class="row-even"><td><p>Avoid numeric labels</p></td>
<td><p><a class="reference internal" href="#s9">S9</a>
<a class="reference internal" href="#s12">S12</a></p></td>
</tr>
<tr class="row-odd"><td><p>Exception is for error trapping,
jump to the label <code class="docutils literal notranslate"><span class="pre">9999</span></code>
<code class="docutils literal notranslate"><span class="pre">CONTINUE</span></code> statement.</p></td>
<td><p><a class="reference internal" href="#s9">S9</a></p></td>
</tr>
<tr class="row-even"><td><p>Continuation line marker must be
<code class="docutils literal notranslate"><span class="pre">&amp;</span></code> at the end of the line.</p></td>
<td><p><a class="reference internal" href="#s10">S10</a></p></td>
</tr>
<tr class="row-odd"><td><p>Always use an <code class="docutils literal notranslate"><span class="pre">ACTION</span></code> when
you <code class="docutils literal notranslate"><span class="pre">OPEN</span></code> a file.</p></td>
<td><p><a class="reference internal" href="#s11">S11</a></p></td>
</tr>
<tr class="row-even"><td><p>Check for file existence with
<code class="docutils literal notranslate"><span class="pre">OPEN</span></code> rather than <code class="docutils literal notranslate"><span class="pre">INQUIRE</span></code></p></td>
<td><p><a class="reference internal" href="#s11">S11</a></p></td>
</tr>
<tr class="row-odd"><td><p>Always format information
explcitly within WRITE, READs
etc.</p></td>
<td><p><a class="reference internal" href="#s12">S12</a></p></td>
</tr>
<tr class="row-even"><td><p>Ensure that output messages do
not use
<code class="docutils literal notranslate"><span class="pre">WR</span>
<span class="pre">ITE(6,...)</span></code>,<code class="docutils literal notranslate"><span class="pre">WRITE(*,...)</span></code>,
or <code class="docutils literal notranslate"><span class="pre">PRINT*</span></code>.</p></td>
<td><p><a class="reference internal" href="#s12">S12</a></p></td>
</tr>
<tr class="row-odd"><td><p>Ensure that output messages are
protected by an appropriate
setting of <code class="docutils literal notranslate"><span class="pre">PrintStatus</span></code>.</p></td>
<td><p><a class="reference internal" href="#s13">S13</a></p></td>
</tr>
<tr class="row-even"><td><p>Ensure your subroutines are
instrumented for DrHook.</p></td>
<td><p><a class="reference internal" href="#s14">S14</a></p></td>
</tr>
<tr class="row-odd"><td><p>Only use OpenMP sentinels at the
beginning of lines <code class="docutils literal notranslate"><span class="pre">!$OMP</span></code></p></td>
<td><p><a class="reference internal" href="#s15">S15</a></p></td>
</tr>
<tr class="row-even"><td><p>Be very careful when altering
calculations within a OpenMP
block.</p></td>
<td><p><a class="reference internal" href="#s15">S15</a></p></td>
</tr>
<tr class="row-odd"><td><p>If possible implement runtime
logicals rather than compile
time logicals.</p></td>
<td><p><a class="reference internal" href="#s17">S17</a></p></td>
</tr>
<tr class="row-even"><td><p>Do not replicate (duplicate)
runtime logic with cpp logic.</p></td>
<td><p><a class="reference internal" href="#s17">S17</a></p></td>
</tr>
<tr class="row-odd"><td><p>Do not protect optional
arguments with cpp flags, use
OPTIONAL args instead.</p></td>
<td><p><a class="reference internal" href="#s17">S17</a></p></td>
</tr>
<tr class="row-even"><td><p>Do not use CPP flags for
selecting science code, use
runtime logicals</p></td>
<td><p><a class="reference internal" href="#s17">S17</a></p></td>
</tr>
<tr class="row-odd"><td><p>Use
<code class="docutils literal notranslate"><span class="pre">#incl</span>
<span class="pre">ude</span> <span class="pre">&quot;modulename_routinename.h&quot;</span></code>
preprocessing directive for
reducing code duplication</p></td>
<td><p><a class="reference internal" href="#s18">S18</a></p></td>
</tr>
<tr class="row-even"><td><p>Never use <code class="docutils literal notranslate"><span class="pre">STOP</span></code> and
<code class="docutils literal notranslate"><span class="pre">CALL</span> <span class="pre">abort</span></code></p></td>
<td><p><a class="reference internal" href="#s19">S19</a></p></td>
</tr>
<tr class="row-odd"><td><p>New namelist items should begin
life as category c items.</p></td>
<td><p><a class="reference internal" href="#namelists">namelists</a></p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="b-fortran-2003">
<span id="appendix-b"></span><h2>B. Fortran 2003<a class="headerlink" href="#b-fortran-2003" title="Link to this heading">#</a></h2>
<p>The following table provides guidance on which Fortran 2003 features are
welcome for inclusion in the UM.</p>
<p>This has been compiled upon review of <a class="reference external" href="http://fortranwiki.org/fortran/show/Fortran+2003+status">major Fortran compilers</a> feature support.</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Feature</strong></p></th>
<th class="head"><p><strong>Acceptable</strong></p></th>
<th class="head"><p><strong>Comment</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ISO TR 15581
Allocatable
Enhancements</p></td>
<td><p>Yes</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>Interoperability with C</p></td>
<td><p>Yes</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>Access to the computing
environment</p></td>
<td><p>Yes</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>Flush</p></td>
<td><p>Yes</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>IOMSG</p></td>
<td><p>Yes</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>Assignment to an
allocatable array</p></td>
<td><p>No</p></td>
<td><p>Includes
auto-reallocation</p></td>
</tr>
<tr class="row-even"><td><p>Intrinsic Modules</p></td>
<td><p>Yes</p></td>
<td><p>eg ISO_C_BINDING</p></td>
</tr>
<tr class="row-odd"><td><p>Allocatable Scalars</p></td>
<td><p>Yes</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>Allocatable Character
lengths</p></td>
<td><p>Yes</p></td>
<td><p>gnu offers partial
support.</p></td>
</tr>
<tr class="row-odd"><td><p>VOLATILE attribute</p></td>
<td><p>Yes</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>Parametrized derived
data types</p></td>
<td><p>No</p></td>
<td><p>Lack of compiler
support</p></td>
</tr>
<tr class="row-odd"><td><p>O-O coding: type
extension, polymorphic
entities, type bound
procedures</p></td>
<td><p>No</p></td>
<td><p>Not for the current UM,
but considered for the
UM replacement,
LFRIC-GUNGHO and MakeBC
replacement CreateBC</p></td>
</tr>
<tr class="row-even"><td><p>Derived type input
output</p></td>
<td><p>No</p></td>
<td><p>Lack of compiler
support</p></td>
</tr>
<tr class="row-odd"><td><p>Kind type parameters of
integer specifiers</p></td>
<td><p>No</p></td>
<td><p>Lack of compiler
support</p></td>
</tr>
<tr class="row-even"><td><p>Recursive input/output</p></td>
<td><p>No</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>Transferring an
allocation</p></td>
<td><p>No</p></td>
<td><p>Prefer to see
DEALLOCATEs used for
code readability.</p></td>
</tr>
<tr class="row-even"><td><p>Support for
international character
sets</p></td>
<td><p>No</p></td>
<td></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="c-dealing-with-rounding-issues">
<span id="appendix-c"></span><h2>C. Dealing with rounding issues.<a class="headerlink" href="#c-dealing-with-rounding-issues" title="Link to this heading">#</a></h2>
<section id="background">
<h3>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h3>
<p>The UM perturbation sensitivity project identified coding issues that lead to
excessive perturbation growth in the model. Problems identified included
<code class="docutils literal notranslate"><span class="pre">IF</span></code> tests that contained comparisons between real numbers; for example
<code class="docutils literal notranslate"><span class="pre">IF</span> <span class="pre">(qCL(i)</span> <span class="pre">&gt;</span> <span class="pre">0.0</span> <span class="pre">)</span></code> In this test, <code class="docutils literal notranslate"><span class="pre">qCL(i)</span></code> is being used to represent one
of two states;</p>
<ul class="simple">
<li><p>“no liquid cloud”</p></li>
<li><p>“some liquid cloud”</p></li>
</ul>
<p>This is fine, but it is then important to ensure that rounding issues do not
lead to unintended changes of state prior to the test, such as slightly
non-zero <code class="docutils literal notranslate"><span class="pre">qCL(i)</span></code> values when there is supposed to be no liquid cloud. If
such problems occur at discontinuous branches in the code, the result is
spurious perturbation growth.</p>
<p>This appendix collects together some typical examples of what can go wrong, and
how to deal with them. First, though, it is worth making a quick note of some
of the characteristics of floating-point arithmetic.</p>
</section>
<section id="floating-point-identities-and-non-identities">
<h3>Floating-point identities and non-identities<a class="headerlink" href="#floating-point-identities-and-non-identities" title="Link to this heading">#</a></h3>
<p>In floating-point arithmetic many of the identities that hold in normal
arithmetic no longer hold, basically because of the limited precision
available to represent real numbers. Thus, it is often important that coders
know which algebraic identities pass through to floating-point arithmetic and
which don’t, and how results can be affected by the way the calculations are
implemented by the compiler. For chapter and verse on floating-point
arithmetic, a good reference is “<a class="reference external" href="https://docs.oracle.com/cd/E19957-01/806-3568/ncg_goldberg.html">David Goldberg’s article</a> “</p>
<p>The following floating-point identity always holds:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">0.0</span> <span class="o">*</span> <span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>
</pre></div>
</div>
<p>The following also hold, but only if the numbers that go into the calculations
have the same precision:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="mf">0.0</span> <span class="o">+</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
  <span class="mf">1.0</span> <span class="o">*</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
  <span class="n">x</span> <span class="o">/</span> <span class="n">x</span> <span class="o">=</span> <span class="mf">1.0</span>
  <span class="n">x</span> <span class="o">-</span> <span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>
  <span class="n">x</span> <span class="o">-</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">y</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">x</span>
  <span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">x</span>
<span class="mf">2.0</span> <span class="o">*</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x</span>
<span class="mf">0.5</span> <span class="o">*</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="mf">2.0</span>
</pre></div>
</div>
<p>For example, optimisation may lead to some variables being held in cache and
others in main memory, and these will generally store numbers with different
levels of precision. Thus, coding based on these identities will probably work
as intended in most circumstances, but may be vulnerable to higher levels of
optimisation.</p>
<p>The following are non-identities:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span> <span class="o">/=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">z</span>
<span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span> <span class="o">/=</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span>
<span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="n">z</span><span class="p">)</span> <span class="o">/=</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span>
</pre></div>
</div>
<p>These say that, unlike in normal arithmetic, the order of the calculations
matters. Failure to recognise this can cause problems, as in example 1 below.
(Note that putting brackets around calculations to try and impose
the “correct” order of calculation will not necessarily work; the compiler
will decide for itself!)</p>
</section>
<section id="example-1-non-distributive-arithmetic">
<h3>Example 1: Non-distributive arithmetic<a class="headerlink" href="#example-1-non-distributive-arithmetic" title="Link to this heading">#</a></h3>
<p>At UM vn7.4, the routine <code class="docutils literal notranslate"><span class="pre">LSP_DEPOSITION</span></code> contains the following
calculation:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">            </span><span class="c">! Deposition removes some liquid water content</span>
<span class="w">            </span><span class="c">! First estimate of the liquid water removed is explicit</span>
<span class="w">            </span><span class="n">dqil</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="w"> </span><span class="p">(</span><span class="nb">min</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dqi_dep</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">area_mix</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">                 </span><span class="p">&amp;</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                </span><span class="o">/</span><span class="p">(</span><span class="n">area_mix</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="n">area_ice_1</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span><span class="w">                     </span><span class="p">&amp;</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                </span><span class="n">qcl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">area_mix</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">cfliq</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
<span class="p">...</span>
<span class="w">          </span><span class="k">If</span><span class="w"> </span><span class="p">(</span><span class="n">l_seq</span><span class="p">)</span><span class="w"> </span><span class="k">Then</span>
<span class="k">            </span><span class="n">qcl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qcl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dqil</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">  </span><span class="c">! Bergeron Findeisen acts first</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">dqil</span></code> is a change to cloud liquid water <code class="docutils literal notranslate"><span class="pre">qcl</span></code>, which is limited in
the calculation to <code class="docutils literal notranslate"><span class="pre">qcl*area_mix/cfliq</span></code>, where <code class="docutils literal notranslate"><span class="pre">area_mix</span></code> is the fraction
of the gridbox with both liquid and ice cloud, and <code class="docutils literal notranslate"><span class="pre">cfliq</span></code> is the fraction
with liquid cloud. Basically, the change to cloud liquid water is being
limited by the amount of liquid cloud which overlaps with ice cloud it can
deposit onto.</p>
<p>In the special case that all the liquid cloud coincides with ice cloud, we have
<code class="docutils literal notranslate"><span class="pre">area_mix</span> <span class="pre">=</span> <span class="pre">cfliq</span></code>, implying <code class="docutils literal notranslate"><span class="pre">area_mix/cfliq</span> <span class="pre">=</span> <span class="pre">1.0</span></code>. In this case, the
limit for <code class="docutils literal notranslate"><span class="pre">dqil</span></code> should be exactly <code class="docutils literal notranslate"><span class="pre">qcl</span></code>, but is coded as
<code class="docutils literal notranslate"><span class="pre">qcl*area_mix/cfliq</span></code>. In tests on the IBM, it seems that the compiler
decides that the multiplication should precede the division, so the outcome of
the calculation is not necessarily <code class="docutils literal notranslate"><span class="pre">qcl</span></code>. Thus, the update to <code class="docutils literal notranslate"><span class="pre">qcl</span></code> on the
last line does not necessarily lead to <code class="docutils literal notranslate"><span class="pre">qcl</span> <span class="pre">=</span> <span class="pre">0.0</span></code> when the limit is hit.</p>
<p>One solution to this problem is to supply <code class="docutils literal notranslate"><span class="pre">area_mix/cfliq</span></code> directly as a
ratio:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">        </span><span class="k">If</span><span class="w"> </span><span class="p">(</span><span class="n">cfliq</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="k">Then</span>
<span class="k">          </span><span class="n">areamix_over_cfliq</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="n">area_mix</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">cfliq</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">        </span><span class="k">End if</span>
<span class="p">...</span>
<span class="w">            </span><span class="c">! Deposition removes some liquid water content</span>
<span class="w">            </span><span class="c">! First estimate of the liquid water removed is explicit</span>
<span class="w">            </span><span class="n">dqil</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="w"> </span><span class="p">(</span><span class="nb">min</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dqi_dep</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">area_mix</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">                 </span><span class="p">&amp;</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                </span><span class="o">/</span><span class="p">(</span><span class="n">area_mix</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="n">area_ice_1</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span><span class="w">                     </span><span class="p">&amp;</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                </span><span class="n">qcl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">areamix_over_cfliq</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
</pre></div>
</div>
<p>This is the solution we have adopted in the large-scale precipitation code.</p>
</section>
<section id="example-2-changing-units-when-applying-limits">
<h3>Example 2: Changing units when applying limits<a class="headerlink" href="#example-2-changing-units-when-applying-limits" title="Link to this heading">#</a></h3>
<p>At UM vn7.4, the routine <code class="docutils literal notranslate"><span class="pre">LSP_TIDY</span></code> contains the following calculation:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">          </span><span class="c">! Calculate transfer rate</span>
<span class="w">          </span><span class="n">dpr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp7</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">lfrcp</span><span class="w"> </span><span class="c">! Rate based on Tw excess</span>

<span class="w">          </span><span class="c">! Limit to the amount of snow available</span>
<span class="w">          </span><span class="n">dpr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">dpr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">snow_agg</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">                             </span><span class="p">&amp;</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                        </span><span class="o">*</span><span class="w"> </span><span class="n">dhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">iterations</span><span class="o">*</span><span class="n">rhor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="p">...</span>
<span class="w">          </span><span class="c">! Update values of snow and rain</span>
<span class="w">          </span><span class="k">If</span><span class="w"> </span><span class="p">(</span><span class="n">l_seq</span><span class="p">)</span><span class="w"> </span><span class="k">Then</span>
<span class="k">            </span><span class="n">snow_agg</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">snow_agg</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dpr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">rho</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">dhilsiterr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">            </span><span class="n">qrain</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">qrain</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">    </span><span class="o">+</span><span class="w"> </span><span class="n">dpr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
<p>where</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="n">dhilsiterr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">dhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">iterations</span><span class="p">)</span>
<span class="n">rhor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="o">/</span><span class="n">rho</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">dpr</span></code> is a conversion rate from snow into rain, and the second
statement limits this rate to that required to melt all of the snow within the
timestep. Thus, the intention is that if this limit is hit the final snow
amount will come out to exactly 0.0. However, the outcome in this case is
effectively as follows:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="n">dpr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">snow_agg</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">iterations</span><span class="o">*</span><span class="n">rhor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="n">snow_agg</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">snow_agg</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dpr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">rho</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">dhilsiterr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">snow_agg</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="o">-</span><span class="w"> </span><span class="n">snow_agg</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="o">*</span><span class="w"> </span><span class="n">dhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">iterations</span><span class="o">*</span><span class="n">rhor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">rho</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">dhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">iterations</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
</pre></div>
</div>
<p>In normal arithmetic, the multiplier on the final line comes out to exactly
one, but this is not necessarily the case in floating-point arithmetic.
Whether the expression comes out to exactly 1.0 or not will be highly
sensitive to the values going into the calculation. If the result is slightly
different to 1.0, the outcome is likely to be a tiny but non-zero snow
amount.</p>
<p>The basic problem here is that the limit comes from a particular quantity, but
is being applied indirectly via its rate of change. Thus when the limiting
quantity is updated a change of units is required. The solution here is to
apply the limit to the quantity itself, shifting the change of units to
calculations involving rates:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">          </span><span class="c">! Calculate transfer</span>
<span class="w">          </span><span class="n">dp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rho</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">dhilsiterr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">temp7</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">lfrcp</span>

<span class="w">          </span><span class="c">! Limit to the amount of snow available</span>
<span class="w">          </span><span class="n">dp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">dp</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">snow_agg</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<span class="p">...</span>
<span class="w">          </span><span class="c">! Update values of snow and rain</span>
<span class="w">          </span><span class="k">If</span><span class="w"> </span><span class="p">(</span><span class="n">l_seq</span><span class="p">)</span><span class="w"> </span><span class="k">Then</span>
<span class="k">            </span><span class="n">snow_agg</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">snow_agg</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">            </span><span class="n">qrain</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">qrain</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">    </span><span class="o">+</span><span class="w"> </span><span class="n">dp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">dhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">iterations</span><span class="o">*</span><span class="n">rhor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-3-dealing-with-special-cases">
<h3>Example 3: Dealing with special cases<a class="headerlink" href="#example-3-dealing-with-special-cases" title="Link to this heading">#</a></h3>
<p>At UM vn7.4, the routine <code class="docutils literal notranslate"><span class="pre">LS_CLD</span></code> contains the following calculation to
update the total cloud fraction <code class="docutils literal notranslate"><span class="pre">CF</span></code> given the liquid and frozen cloud
fractions <code class="docutils literal notranslate"><span class="pre">CFL</span></code> and <code class="docutils literal notranslate"><span class="pre">CFF</span></code>:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">            </span><span class="n">TEMP0</span><span class="o">=</span><span class="n">OVERLAP_RANDOM</span>
<span class="w">            </span><span class="n">TEMP1</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">OVERLAP_MAX</span><span class="o">-</span><span class="n">OVERLAP_MIN</span><span class="p">)</span>
<span class="w">            </span><span class="n">TEMP2</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">OVERLAP_MAX</span><span class="o">+</span><span class="n">OVERLAP_MIN</span><span class="p">)</span><span class="o">-</span><span class="n">OVERLAP_RANDOM</span>
<span class="w">            </span><span class="n">CF</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">)</span><span class="o">=</span><span class="n">CFL</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">)</span><span class="o">+</span><span class="n">CFF</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">)</span><span class="w">                             </span><span class="p">&amp;</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">              </span><span class="o">-</span><span class="p">(</span><span class="n">TEMP0</span><span class="o">+</span><span class="n">TEMP1</span><span class="o">*</span><span class="n">OVERLAP_ICE_LIQUID</span><span class="w">                    </span><span class="p">&amp;</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">              </span><span class="o">+</span><span class="n">TEMP2</span><span class="o">*</span><span class="n">OVERLAP_ICE_LIQUID</span><span class="o">*</span><span class="n">OVERLAP_ICE_LIQUID</span><span class="p">)</span>
<span class="c">! Check that the overlap wasnt negative</span>
<span class="w">            </span><span class="n">CF</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">)</span><span class="o">=</span><span class="nb">MIN</span><span class="p">(</span><span class="n">CF</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">),</span><span class="n">CFL</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">)</span><span class="o">+</span><span class="n">CFF</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">))</span>
</pre></div>
</div>
<p>During testing, it was observed that <code class="docutils literal notranslate"><span class="pre">CF</span></code> was often coming out to
<code class="docutils literal notranslate"><span class="pre">0.9999999999999....</span></code>; i.e., almost but not quite 1.0, and that whether this
occured was highly sensitive to the input data. This sensitivity was then
being passed down to branches testing on, for example, whether <code class="docutils literal notranslate"><span class="pre">CF</span></code> was
equal to <code class="docutils literal notranslate"><span class="pre">CFF</span></code>.</p>
<p>If the above calculations are followed through algebraically, it can be shown
that if <code class="docutils literal notranslate"><span class="pre">CFL+CFF</span> <span class="pre">&gt;=</span> <span class="pre">1</span></code>, then <code class="docutils literal notranslate"><span class="pre">CF</span></code> must be exactly one. In the
floating-point case, however, this no longer follows, so we often get cases
where there is a slight deviation from unity. The simplest solution in this
example is to deal with the special case separately:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">            </span><span class="n">TEMP0</span><span class="o">=</span><span class="n">OVERLAP_RANDOM</span>
<span class="w">            </span><span class="n">TEMP1</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">OVERLAP_MAX</span><span class="o">-</span><span class="n">OVERLAP_MIN</span><span class="p">)</span>
<span class="w">            </span><span class="n">TEMP2</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">OVERLAP_MAX</span><span class="o">+</span><span class="n">OVERLAP_MIN</span><span class="p">)</span><span class="o">-</span><span class="n">OVERLAP_RANDOM</span>
<span class="c">! CFF + CFL &gt;= 1 implies CF = 1</span>
<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">CFL</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">)</span><span class="o">+</span><span class="n">CFF</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">              </span><span class="n">CF</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">            </span><span class="k">ELSE</span>
<span class="k">              </span><span class="n">CF</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">)</span><span class="o">=</span><span class="n">CFL</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">)</span><span class="o">+</span><span class="n">CFF</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">)</span><span class="w">                             </span><span class="p">&amp;</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                </span><span class="o">-</span><span class="p">(</span><span class="n">TEMP0</span><span class="o">+</span><span class="n">TEMP1</span><span class="o">*</span><span class="n">OVERLAP_ICE_LIQUID</span><span class="w">                    </span><span class="p">&amp;</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                </span><span class="o">+</span><span class="n">TEMP2</span><span class="o">*</span><span class="n">OVERLAP_ICE_LIQUID</span><span class="o">*</span><span class="n">OVERLAP_ICE_LIQUID</span><span class="p">)</span>
<span class="c">! Check that the overlap wasnt negative</span>
<span class="w">              </span><span class="n">CF</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">)</span><span class="o">=</span><span class="nb">MIN</span><span class="p">(</span><span class="n">CF</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">),</span><span class="n">CFL</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">)</span><span class="o">+</span><span class="n">CFF</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">))</span>
<span class="w">            </span><span class="k">END IF</span>
</pre></div>
</div>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="change_notes.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Recent Changes</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-have-standards">Why have standards?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#units">Units</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#working-practices">Working practices</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examples">Examples</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#technical-standards">Technical standards</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pre-processor">Pre-processor</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-meet-the-coding-standards">How to meet the coding standards</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#um-programming-standards-code-layout-formatting-style-and-fortran-features">UM programming standards; Code Layout, Formatting, Style and Fortran features</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s1-source-files-should-only-contain-a-single-program-unit">S1. Source files should only contain a single program unit</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s2-headers">S2. Headers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s3-free-source-form">S3. Free source form</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s4-fortran-style">S4. Fortran style</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s5-comments-and-white-spacing">S5. Comments and white spacing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s6-the-use-of-modules">S6. The use of modules</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s7-argument-and-variable-declaration">S7. Argument and variable declaration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s8-allocatables">S8. Allocatables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s9-code-if-blocks-do-loops-and-other-constructs">S9. Code IF blocks, DO LOOPs, and other constructs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s10-line-continuation">S10. Line continuation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s11-fortran-i-o">S11. Fortran I/O</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s12-formatting-and-output-of-text">S12. Formatting and output of text</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s13-printstatus">S13. PrintStatus</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s14-drhook">S14. DrHook</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s15-openmp">S15. OpenMP</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s16-mpi">S16. MPI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s17-preprocessing">S17. Preprocessing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s18-code-duplication">S18. Code duplication</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s19-error-reporting">S19. Error reporting</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#specific-standards">Specific standards</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#runtime-namelist-variables-defaults-future-development">Runtime namelist variables, defaults, future development</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defensive-input-programming">Defensive input programming</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optimised-namelist-reading-procedures">Optimised namelist reading procedures</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#unix-script-standards">Unix script standards</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#python-standards">Python standards</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c-standards">C standards</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing-of-c">Preprocessing of C</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#code-layout">Code Layout</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#copyright-and-code-owner-comments">Copyright and Code Owner Comments</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#deprecated-identifiers">Deprecated identifiers</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#openmp-in-c-code">OpenMP in C Code</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#protecting-openmp-in-c-code">Protecting OpenMP in C Code</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#other-uses-of-the-openmp-macro">Other Uses of the _OPENMP Macro</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#further-rules-for-openmp-in-c">Further Rules for OpenMP in C</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#code-reviews">Code Reviews</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-um-software-standard-summary">A. UM Software standard summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#b-fortran-2003">B. Fortran 2003</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#c-dealing-with-rounding-issues">C. Dealing with rounding issues.</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#floating-point-identities-and-non-identities">Floating-point identities and non-identities</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-non-distributive-arithmetic">Example 1: Non-distributive arithmetic</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-changing-units-when-applying-limits">Example 2: Changing units when applying limits</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-3-dealing-with-special-cases">Example 3: Dealing with special cases</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

<p class="copyright">
    
    © Crown Copyright, Met Office
    <br/>
    
</p>
</div>
      
    </div>
  
  
    <div class="footer-items__center">
      
        <div class="footer-item">
<div class="tocsection accessibilitylink">
        <a href="../accessibility.html">Accessibility</a>
</div></div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>